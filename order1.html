<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="icon.ico" type="image/x-icon" />
  <title>Download Free Book</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    @keyframes drop-swing {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 0; }
      20% { opacity: 1; }
      30% { transform: translateY(30px) rotate(8deg); }
      50% { transform: translateY(60px) rotate(-8deg); }
      70% { transform: translateY(90px) rotate(5deg); }
      100% { transform: translateY(120px) rotate(0deg); }
    }
    .animate-drop-swing { animation: drop-swing 2.5s ease forwards; }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

  <div class="max-w-lg w-full bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Download Book</h2>

    <!-- Download form -->
    <form id="download-form" class="space-y-4">
      <label class="block text-sm font-semibold text-gray-700">Book Name</label>
      <input type="text" id="book-name" class="w-full px-4 py-2 border rounded bg-gray-100" readonly />

      <label class="block text-sm font-semibold text-gray-700">Price</label>
      <input type="text" id="book-price" value="0" class="w-full px-4 py-2 border rounded bg-gray-100" readonly />

      <label class="block text-sm font-semibold text-gray-700">Your Name</label>
      <input type="text" id="user-name" class="w-full px-4 py-2 border rounded" required />

      <label class="block text-sm font-semibold text-gray-700">Email</label>
      <input type="email" id="user-email" class="w-full px-4 py-2 border rounded" required />

      <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded font-bold hover:bg-green-700">
        Download Book
      </button>
    </form>

    <!-- Animation -->
    <div id="download-animation" class="relative h-52 mt-6 hidden flex flex-col items-center justify-start">
      <div class="absolute top-0 animate-drop-swing">
        <svg class="w-20 h-20" viewBox="0 0 100 100" fill="none">
          <path d="M50 5C30 5 15 20 15 35H85C85 20 70 5 50 5Z" fill="#4ade80"/>
          <line x1="35" y1="35" x2="45" y2="65" stroke="#555" stroke-width="2"/>
          <line x1="65" y1="35" x2="55" y2="65" stroke="#555" stroke-width="2"/>
          <rect x="45" y="65" width="10" height="10" fill="#a16207" stroke="#000" stroke-width="1"/>
        </svg>
      </div>
      <p id="downloaded-text" class="text-green-700 font-semibold mt-40 hidden text-lg">Book Downloaded! ðŸ“š</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBlOVx-YSmPFeq3lp-gAGe576yG1RhMLYs",
      authDomain: "mymlibraryreads.firebaseapp.com",
      projectId: "mymlibraryreads",
      storageBucket: "mymlibraryreads.firebasestorage.app",
      messagingSenderId: "11947740896",
      appId: "1:11947740896:web:87482eb72210acdba50a85"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // EmailJS init
    (function () { emailjs.init("h43f0gQjAVupGqnPd"); })();

    // Get params from URL
    const params = new URLSearchParams(window.location.search);
    const bookId = params.get("bookId");
    const bookName = decodeURIComponent(params.get("bookName") || "");
    const fileUrl = decodeURIComponent(params.get("file") || "");

    document.getElementById("book-name").value = bookName || "No Book Specified";

    // Local storage helpers
    function getReadBooks() {
      return JSON.parse(localStorage.getItem("readBooks") || "[]");
    }
    function setReadBooks(books) {
      localStorage.setItem("readBooks", JSON.stringify(books));
    }

    // Form submit
    document.getElementById("download-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const name = document.getElementById("user-name").value;
      const email = document.getElementById("user-email").value;

      // Save user data
      localStorage.setItem("userData", JSON.stringify({ name, email }));

      // Send email
      await emailjs.send("service_2j2mr61", "template_lqjv3pg", {
        book_name: bookName,
        book_price: "0",
        customer_name: name,
        customer_email: email
      });

      // Update Firebase reads
      try {
        await updateDoc(doc(db, "Books", bookId), { Reads: increment(1) });
      } catch (err) {
        console.error(err);
      }

      // Save locally
      let readBooks = getReadBooks();
      if (!readBooks.includes(bookId)) {
        readBooks.push(bookId);
        setReadBooks(readBooks);
      }

      // Show animation and download
      document.getElementById("download-animation").classList.remove("hidden");
      setTimeout(() => {
        document.getElementById("downloaded-text").classList.remove("hidden");

        if (fileUrl) {
          const a = document.createElement("a");
          a.href = fileUrl;
          a.download = "";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        // Return to main page after 2s
        setTimeout(() => { window.location.href = "https://mymlibrary.vercel.app/books"; }, 2000);
      }, 2600);
    });
  </script>
</body>
</html>
