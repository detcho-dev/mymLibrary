<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Browse and explore our collection of the best and most popular books available in MYM Library." />
  <link rel="icon" href="icon.ico" type="image/x-icon" />
  <title>MYM Library - Explore Books</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  
  <style>
    /* Same CSS styles as before - no changes needed */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --color-primary: #3b82f6;
      --color-primary-dark: #2563eb;
      --color-secondary: #8b5cf6;
      --color-accent: #f59e0b;
      --bg-dark: #0f172a;
      --bg-dark-light: #1e293b;
      --text-light: #f1f5f9;
      --text-gray: #94a3b8;
      --border-color: #334155;
      --card-bg: #1e293b;
      --shadow-color: rgba(0, 0, 0, 0.3);
    }
    
    html.dark {
      background-color: var(--bg-dark);
      color: var(--text-light);
    }
    
    /* Rest of the CSS styles remain the same */
    .btn-primary {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
      width: 100%;
      border: none;
      cursor: pointer;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4);
    }
    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
    }
    
    /* ... rest of CSS unchanged ... */
    
    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Media queries and other styles remain unchanged */
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

<!-- Header, Sidebar, and UI elements remain the same -->
<header class="fixed top-0 left-0 w-full bg-gray-900/80 backdrop-blur-sm border-b border-gray-800 z-50">
  <!-- Header content unchanged -->
  <nav class="container mx-auto px-4 py-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="relative">
          <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center">
            <span class="text-xl font-bold text-white">MYM</span>
          </div>
          <span class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-900"></span>
        </div>
        <h1 class="header-title text-xl md:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
          MYM Library
        </h1>
      </div>
      
      <div class="flex items-center gap-3 header-actions">
        <!-- Search and other controls unchanged -->
        <div class="search-container relative">
          <input id="search-input" type="search" placeholder="Search books..." class="search-input focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="search-icon w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A2.25 2.25 0 0113.5 15.75l-2.697.343m-2.697.343a2.25 2.25 0 01-1.91-1.91L6.25 12H4.5m4.06-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91-1.91L2.25 6.75 4.5 4.5m4.06-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L2.25 7.5 4.5 9.75m14.25-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L15.75 12h-3.375m-2.193-1.51l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L9 15.75V18m3.06-12.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L9 12.75v2.032c0 .418.336.754.754.754h4.082c.418 0 .754-.336.754-.754V12.75c0-.418-.336-.754-.754-.754h-1.082a2.25 2.25 0 00-1.91 1.91z" />
          </svg>
        </div>
        
        <!-- Other header buttons unchanged -->
        <button id="search-toggle" class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-800 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A2.25 2.25 0 0113.5 15.75l-2.697.343m-2.697.343a2.25 2.25 0 01-1.91-1.91L6.25 12H4.5m4.06-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91-1.91L2.25 6.75 4.5 4.5m4.06-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L2.25 7.5 4.5 9.75m14.25-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L15.75 12h-3.375m-2.193-1.51l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L9 15.75V18m3.06-12.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L9 12.75v2.032c0 .418.336.754.754.754h4.082c.418 0 .754-.336.754-.754V12.75c0-.418-.336-.754-.754-.754h-1.082a2.25 2.25 0 00-1.91 1.91z" />
          </svg>
        </button>
        
        <button id="language-toggle" class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-800 transition-colors">
          <span class="en font-medium">EN</span>
          <span class="ar hidden font-medium">AR</span>
        </button>
        
        <button id="sidebar-toggle" class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-800 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
        </button>
        
        <button id="leaderboard-toggle" class="leaderboard-desktop bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.504-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 01-.982-3.172M9.497 14.25a7.454 7.454 0 00.981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 007.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 002.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492c.962-.203 1.934-.377 2.916-.52" />
          </svg>
          Leaderboard
        </button>
      </div>
    </div>
  </nav>
</header>

<!-- Sidebar, User Popup, and other UI elements unchanged -->

<div class="container mx-auto mt-24 px-4 pb-8">
  <h1 class="text-2xl md:text-3xl font-bold mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
    Explore Our Collection
  </h1>
  
  <div class="flex justify-center mb-8">
    <div class="filters-container flex flex-wrap justify-center gap-2 max-w-4xl">
      <span class="filter-badge bg-blue-500/20 text-blue-300 active">All</span>
      <span class="filter-badge bg-gray-700 text-gray-300 hover:bg-gray-600">Fiction</span>
      <span class="filter-badge bg-gray-700 text-gray-300 hover:bg-gray-600">Non-Fiction</span>
      <span class="filter-badge bg-gray-700 text-gray-300 hover:bg-gray-600">Biography</span>
      <span class="filter-badge bg-gray-700 text-gray-300 hover:bg-gray-600">Science</span>
      <span class="filter-badge bg-gray-700 text-gray-300 hover:bg-gray-600">History</span>
      <span class="filter-badge bg-gray-700 text-gray-300 hover:bg-gray-600">Technology</span>
      <span class="filter-badge bg-gray-700 text-gray-300 hover:bg-gray-600">Philosophy</span>
    </div>
  </div>

  <!-- Books grid -->
  <div id="books-grid" class="books-grid grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto">
    <div class="loader col-span-full">
      <div class="spinner"></div>
    </div>
  </div>
  
  <div class="notification" id="notification">
    Book added to your list
  </div>
</div>

<!-- Floating buttons unchanged -->
<div class="floating-btn md:hidden" id="mobile-sidebar-toggle">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
  </svg>
</div>

<div class="floating-btn md:hidden leaderboard-mobile" id="mobile-leaderboard-toggle" style="right: 100px; bottom: 30px;">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.504-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 01-.982-3.172M9.497 14.25a7.454 7.454 0 00.981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 007.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 002.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492c.962-.203 1.934-.377 2.916-.52" />
  </svg>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBlOVx-YSmPFeq3lp-gAGe576yG1RhMLYs",
    authDomain: "mymlibraryreads.firebaseapp.com",
    projectId: "mymlibraryreads",
    storageBucket: "mymlibraryreads.firebasestorage.app",
    messagingSenderId: "11947740896",
    appId: "1:11947740896:web:87482eb72210acdba50a85"
  };

  // Initialize Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  
  const db = firebase.firestore();
  const booksCollection = db.collection("Books");
  
  // User data storage
  let userData = {
    userId: null,
    name: "User",
    email: "user@example.com",
    readCount: 0
  };

  // Book list storage
  let bookList = [];
  
  // Initialize user data from URL parameters
  function initUserData() {
    const params = new URLSearchParams(window.location.search);
    const userId = params.get('userId');
    
    if (userId) {
      // Fetch user data from Firestore
      db.collection("Users").doc(userId).get()
        .then((doc) => {
          if (doc.exists) {
            const data = doc.data();
            userData = {
              userId: userId,
              name: data.name || "User",
              email: data.email || "user@example.com",
              readCount: data.readCount || 0
            };
            
            // Update UI
            document.getElementById('user-name').textContent = userData.name;
            document.getElementById('user-read-count').textContent = `${userData.readCount} books read`;
            document.getElementById('user-email').textContent = userData.email;
            
            document.getElementById('popup-user-name').textContent = userData.name;
            document.getElementById('popup-user-read-count').textContent = `${userData.readCount} books read`;
            document.getElementById('popup-user-email').textContent = userData.email;
            
            // Show popup
            document.getElementById('user-popup').classList.remove('hidden');
          } else {
            // User not found, redirect to login
            window.location.href = '/library/login';
          }
        })
        .catch((error) => {
          console.error("Error getting user document:", error);
          window.location.href = '/login';
        });
    } else {
      // Redirect to login if no user ID
      window.location.href = '/login';
    }
  }

  // Rest of the functions remain the same
  
  function getBookList() {
    try {
      return JSON.parse(localStorage.getItem("bookList") || "[]");
    } catch {
      return [];
    }
  }

  function setBookList(books) {
    localStorage.setItem("bookList", JSON.stringify(books));
    bookList = books;
    updateBookListUI();
  }

  function addToBookList(book) {
    if (!bookList.some(b => b.id === book.id)) {
      bookList.push(book);
      setBookList(bookList);
      showNotification(`Added "${book.title}" to your list`);
    }
  }

  function removeFromBookList(bookId) {
    bookList = bookList.filter(b => b.id !== bookId);
    setBookList(bookList);
  }

  function clearBookList() {
    bookList = [];
    setBookList(bookList);
  }

  function updateBookListUI() {
    const bookListEl = document.getElementById('book-list');
    const sidebar = document.getElementById('sidebar');
    
    if (bookList.length === 0) {
      sidebar.classList.add('sidebar-empty');
    } else {
      sidebar.classList.remove('sidebar-empty');
      
      bookListEl.innerHTML = bookList.map(book => `
        <div class="book-list-item">
          <div class="flex items-center">
            <img src="${book.coverURL || 'placeholder.jpg'}" alt="${book.title}" class="w-12 h-12 object-cover rounded-lg mr-3">
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-medium truncate">${book.title}</h4>
              <p class="text-xs text-gray-400 truncate">by ${book.author}</p>
            </div>
            <button data-book-id="${book.id}" class="remove-from-list text-gray-400 hover:text-red-500 p-1 hover:bg-red-500/10 rounded-full transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      `).join('');
      
      // Add event listeners for remove buttons
      document.querySelectorAll('.remove-from-list').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const bookId = e.currentTarget.dataset.bookId;
          removeFromBookList(bookId);
          showNotification("Book removed from list");
        });
      });
    }
  }

  function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }

  function downloadBook(bookName) {
    const fileUrl = `/library/books/${bookName}.pdf`;
    
    // Check if the file exists before downloading
    fetch(fileUrl, { method: 'HEAD' })
      .then(response => {
        if (response.ok) {
          const a = document.createElement("a");
          a.href = fileUrl;
          a.download = `${bookName}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          showNotification(`Downloading "${bookName}"...`);
        } else {
          throw new Error('File not found');
        }
      })
      .catch(error => {
        console.error("Download error:", error);
        showNotification(`Failed to download "${bookName}". File not found.`);
      });
  }

  // FIXED: handleDownload now properly uses async/await
  async function handleDownload(bookId, bookName, buttonEl) {
    try {
      // Mark as read
      let readBooks = getReadBooks();
      if (!readBooks.includes(bookId)) {
        readBooks.push(bookId);
        setReadBooks(readBooks);
        
        // Update Firebase
        await db.collection("Books").doc(bookId).update({ 
          Reads: firebase.firestore.FieldValue.increment(1) 
        });
        
        // Update user's read count
        userData.readCount++;
        updateReadCounterUI();
        
        // Update user document
        if (userData.userId) {
          await db.collection("Users").doc(userData.userId).update({ 
            readCount: firebase.firestore.FieldValue.increment(1) 
          });
        }
      }
      
      // Download the book
      downloadBook(bookName);
      
      // Update button state
      buttonEl.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
        </svg>
        Downloaded
      `;
      buttonEl.disabled = true;
      buttonEl.classList.add("opacity-70", "cursor-not-allowed", "bg-green-600", "hover:bg-green-700");
      
      showNotification(`"${bookName}" downloaded successfully!`);
      
    } catch (err) {
      console.error("Download error:", err);
      showNotification("Failed to download book. Please try again.");
    }
  }

  function getReadBooks() {
    try {
      return JSON.parse(localStorage.getItem("readBooks") || "[]");
    } catch {
      return [];
    }
  }

  function setReadBooks(books) {
    localStorage.setItem("readBooks", JSON.stringify(books));
  }

  function updateReadCounterUI() {
    document.getElementById('user-read-count').textContent = `${userData.readCount} books read`;
    document.getElementById('popup-user-read-count').textContent = `${userData.readCount} books read`;
  }

  function searchBooks(query) {
    query = query.trim().toLowerCase();
    document.querySelectorAll(".book-card").forEach(book => {
      if (query === "") {
        book.style.display = "block";
      } else {
        const title = book.dataset.title.toLowerCase();
        const author = book.dataset.author.toLowerCase();
        const categories = book.dataset.categories.toLowerCase();
        book.style.display = (title.includes(query) || author.includes(query) || categories.includes(query)) 
          ? "block" 
          : "none";
      }
    });
  }

  function applyFilters() {
    const activeFilter = document.querySelector('.filter-badge.active');
    if (!activeFilter || activeFilter.textContent === 'All') {
      document.querySelectorAll(".book-card").forEach(book => {
        book.style.display = "block";
      });
      return;
    }
    
    const filterName = activeFilter.textContent.toLowerCase();
    document.querySelectorAll(".book-card").forEach(book => {
      const categories = book.dataset.categories.toLowerCase();
      book.style.display = categories.includes(filterName) ? "block" : "none";
    });
  }

  function renderBook(doc) {
    const data = doc.data();
    const booksGrid = document.getElementById("books-grid");

    // Process categories
    let categories = [];
    if (Array.isArray(data.Categories)) {
      categories = data.Categories;
    } else if (typeof data.Categories === "string") {
      categories = data.Categories.split(",").map(c => c.trim());
    }
    const categoriesStr = categories.join(",");

    let bookEl = document.querySelector(`.book-card[data-book-id="${doc.id}"]`);
    if (!bookEl) {
      bookEl = document.createElement("div");
      bookEl.className = "book-card relative";
      bookEl.dataset.bookId = doc.id;
      bookEl.dataset.title = data.Title;
      bookEl.dataset.author = data.Author;
      bookEl.dataset.categories = categoriesStr;
      booksGrid.appendChild(bookEl);
    }

    // Determine book type
    const bookType = data.Section === "members" ? "member" : "reader";
    const badgeClass = bookType === "member" ? "book-type-badge-member" : "book-type-badge-reader";

    bookEl.innerHTML = `
      <div class="relative">
        <div class="book-type-badge ${badgeClass}">${bookType}</div>
        <div class="h-56 overflow-hidden">
          <img src="${data.CoverURL || 'placeholder.jpg'}" alt="${data.Title}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-105" />
        </div>
      </div>
      <div class="p-4">
        <h3 class="font-bold text-lg mb-1 line-clamp-2">${data.Title}</h3>
        <p class="text-gray-400 mb-3 text-sm line-clamp-1">By ${data.Author}</p>
        <div class="flex flex-wrap gap-1.5 mb-4">
          ${categories.map(c => `
            <span class="category-badge px-2 py-1 bg-gray-800 text-blue-300 rounded-md text-xs">${c}</span>
          `).join("")}
        </div>
        <div class="flex gap-2">
          <button class="btn-primary" 
                  data-purchase="${data.PurchaseText}">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Download
          </button>
          <button class="add-to-list w-10 h-10 rounded-xl bg-gray-800 flex items-center justify-center text-gray-300 hover:bg-blue-600 hover:text-white transition-all duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
          </button>
        </div>
      </div>
    `;

    const downloadBtn = bookEl.querySelector("[data-purchase]");
    if (downloadBtn) {
      if (getReadBooks().includes(doc.id)) {
        downloadBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
          Downloaded
        `;
        downloadBtn.disabled = true;
        downloadBtn.classList.add("opacity-70", "cursor-not-allowed", "bg-green-600", "hover:bg-green-700");
      }
      downloadBtn.addEventListener("click", () => {
        handleDownload(doc.id, downloadBtn.dataset.purchase, downloadBtn);
      });
    }
    
    const addToListBtn = bookEl.querySelector(".add-to-list");
    addToListBtn.addEventListener("click", () => {
      addToBookList({
        id: doc.id,
        title: data.Title,
        author: data.Author,
        coverURL: data.CoverURL
      });
      addToListBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
        </svg>
      `;
      addToListBtn.classList.replace("bg-gray-800", "bg-green-600");
      addToListBtn.classList.replace("text-gray-300", "text-white");
      setTimeout(() => {
        addToListBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
        `;
        addToListBtn.classList.replace("bg-green-600", "bg-gray-800");
        addToListBtn.classList.replace("text-white", "text-gray-300");
      }, 1500);
    });
  }

  // Initialize the app
  initUserData();
  
  bookList = getBookList();
  updateBookListUI();
  
  if (!localStorage.getItem("readBooks")) setReadBooks([]);
  
  // Firebase listener for books
  booksCollection.onSnapshot(snapshot => {
    const loader = document.querySelector('.loader');
    if (loader) {
      loader.remove();
    }
    
    if (snapshot.empty) {
      document.getElementById("books-grid").innerHTML = `
        <div class="text-center py-12 col-span-full">
          <div class="inline-block mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto text-gray-500">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.987 8.987 0 00-6 2.292m0-14.25v14.25" />
            </svg>
          </div>
          <p class="text-gray-400 font-medium">No books available at the moment</p>
        </div>
      `;
      return;
    }
    
    snapshot.docChanges().forEach(change => {
      if (change.type === "added" || change.type === "modified") {
        renderBook(change.doc);
      } else if (change.type === "removed") {
        const el = document.querySelector(`.book-card[data-book-id="${change.doc.id}"]`);
        if (el) el.remove();
      }
    });
  }, error => {
    console.error("Error fetching books:", error);
    document.getElementById("books-grid").innerHTML = `
      <div class="text-center py-12 col-span-full">
        <div class="inline-block mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto text-red-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
        </div>
        <p class="text-gray-400 font-medium">Failed to load books. Please try again later.</p>
        <button class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white" onclick="location.reload()">
          Retry
        </button>
      </div>
    `;
  });
  
  // FIXED: Download all functionality with proper async handling
  document.getElementById("download-all").addEventListener("click", async () => {
    if (bookList.length === 0) {
      showNotification("Your list is empty");
      return;
    }
    
    bookList.forEach(book => {
      downloadBook(book.title);
    });
    
    const readBooks = getReadBooks();
    let newBooksAdded = 0;
    bookList.forEach(book => {
      if (!readBooks.includes(book.id)) {
        readBooks.push(book.id);
        newBooksAdded++;
      }
    });
    
    if (newBooksAdded > 0) {
      setReadBooks(readBooks);
      
      // Update Firebase for each book - no awaits needed here since we don't need to wait for each update
      bookList.forEach(book => {
        db.collection("Books").doc(book.id).update({ 
          Reads: firebase.firestore.FieldValue.increment(1) 
        }).catch(error => {
          console.error(`Error updating reads for ${book.id}:`, error);
        });
      });
      
      userData.readCount += newBooksAdded;
      updateReadCounterUI();
      
      // Update user read count in database
      if (userData.userId) {
        try {
          await db.collection("Users").doc(userData.userId).update({ 
            readCount: firebase.firestore.FieldValue.increment(newBooksAdded) 
          });
        } catch (error) {
          console.error("Error updating user read count:", error);
        }
      }
    }
    
    clearBookList();
    showNotification(`Downloaded ${bookList.length} books successfully!`);
  });
  
  // Other event listeners remain the same
  document.getElementById("clear-list").addEventListener("click", () => {
    if (bookList.length > 0) {
      clearBookList();
      showNotification("List cleared successfully");
    } else {
      showNotification("Your list is already empty");
    }
  });
  
  document.getElementById("close-popup").addEventListener("click", () => {
    document.getElementById("user-popup").classList.add("hidden");
  });
  
  const searchInput = document.getElementById("search-input");
  const searchToggle = document.getElementById("search-toggle");
  
  searchToggle.addEventListener("click", () => {
    searchInput.classList.toggle("active");
    if (searchInput.classList.contains("active")) {
      searchInput.focus();
    } else {
      searchInput.blur();
    }
  });
  
  searchInput.addEventListener("input", (e) => {
    searchBooks(e.target.value);
  });
  
  document.addEventListener("click", (e) => {
    if (!searchToggle.contains(e.target) && 
        !searchInput.contains(e.target) && 
        !document.querySelector(".search-container").contains(e.target) && 
        searchInput.classList.contains("active")) {
      searchInput.classList.remove("active");
    }
  });
  
  document.querySelectorAll('.filter-badge').forEach(badge => {
    badge.addEventListener('click', function() {
      document.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      applyFilters();
    });
  });
  
  document.getElementById("sidebar-toggle").addEventListener("click", () => {
    document.getElementById("sidebar").classList.add("open");
  });
  
  document.getElementById("sidebar-close").addEventListener("click", () => {
    document.getElementById("sidebar").classList.remove("open");
  });
  
  document.getElementById("mobile-sidebar-toggle").addEventListener("click", () => {
    document.getElementById("sidebar").classList.add("open");
  });
  
  document.addEventListener("click", (e) => {
    const sidebar = document.getElementById("sidebar");
    if (sidebar.classList.contains("open") && 
        !sidebar.contains(e.target) && 
        !document.getElementById("sidebar-toggle").contains(e.target) &&
        !document.getElementById("mobile-sidebar-toggle").contains(e.target)) {
      sidebar.classList.remove("open");
    }
  });
  
  document.getElementById("language-toggle").addEventListener("click", () => {
    const enText = document.querySelector('.en');
    const arText = document.querySelector('.ar');
    
    if (enText.classList.contains('hidden')) {
      enText.classList.remove('hidden');
      arText.classList.add('hidden');
      document.documentElement.setAttribute('dir', 'ltr');
      
      document.getElementById('user-read-count').textContent = `${userData.readCount} books read`;
      document.getElementById('popup-user-read-count').textContent = `${userData.readCount} books read`;
      document.getElementById('download-all').innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
        </svg>
        Download All
      `;
      document.getElementById('clear-list').innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
        </svg>
        Clear List
      `;
      document.getElementById('close-popup').textContent = 'Continue to Library';
    } else {
      enText.classList.add('hidden');
      arText.classList.remove('hidden');
      document.documentElement.setAttribute('dir', 'rtl');
      
      document.getElementById('user-read-count').textContent = `قرأت ${userData.readCount} كتاب`;
      document.getElementById('popup-user-read-count').textContent = `قرأت ${userData.readCount} كتاب`;
      document.getElementById('download-all').innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
        </svg>
        تنزيل الكل
      `;
      document.getElementById('clear-list').innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
        </svg>
        مسح القائمة
      `;
      document.getElementById('close-popup').textContent = 'استمرار إلى المكتبة';
    }
  });
  
  document.getElementById("leaderboard-toggle").addEventListener("click", () => {
    window.location.href = '/leaderboard';
  });
  
  document.getElementById("mobile-leaderboard-toggle").addEventListener("click", () => {
    window.location.href = '/leaderboard';
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.getElementById("sidebar").classList.remove("open");
      document.getElementById("user-popup").classList.add("hidden");
      document.getElementById("search-input").classList.remove("active");
    }
  });
  
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      if (window.innerWidth >= 768 && document.getElementById("sidebar").classList.contains("open")) {
        document.getElementById("sidebar").classList.remove("open");
      }
    }, 250);
  });
});
</script>

</body>
</html>
