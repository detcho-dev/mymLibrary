<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MYM Library</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/confetti-js@0.0.18/dist/index.min.js"></script>
  <style>
    :root {
      --primary: #6b46c1;
      --secondary: #4f46e5;
      --dark: #0f0c1a;
      --darker: #090712;
      --light: #f7fafc;
      --gray: #4a5568;
      --gray-light: #718096;
      --accent: #38b2ac;
      --success: #4cd560;
      --error: #e53e3e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--dark);
      color: var(--light);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background-color: var(--darker);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--light);
    }

    .logo span {
      color: var(--primary);
    }

    .header-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .language-switcher {
      position: relative;
      display: inline-block;
    }

    .language-btn {
      background: none;
      border: none;
      color: var(--light);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .language-dropdown {
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--darker);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      min-width: 120px;
      z-index: 1000;
      display: none;
    }

    .language-dropdown.show {
      display: block;
    }

    .language-option {
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .language-option:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .main-content {
      padding: 30px 0;
    }

    .section-title {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 30px;
      color: var(--primary);
      position: relative;
    }

    .section-title::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--light);
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-btn:hover, .filter-btn.active {
      background-color: var(--primary);
      color: white;
    }

    .books-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .book-card {
      background-color: var(--darker);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .book-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    .book-type-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      z-index: 10;
    }

    .book-type-badge.free {
      background-color: var(--success);
      color: var(--dark);
    }

    .book-type-badge.premium {
      background-color: var(--primary);
      color: var(--light);
    }

    .book-image {
      height: 250px;
      overflow: hidden;
    }

    .book-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }

    .book-card:hover .book-image img {
      transform: scale(1.05);
    }

    .book-info {
      padding: 15px;
    }

    .book-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 8px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .book-author {
      color: #9ca3af;
      font-size: 0.875rem;
      margin-bottom: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .categories {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 15px;
    }

    .category-badge {
      padding: 4px 8px;
      border-radius: 12px;
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--primary);
      font-size: 0.75rem;
      font-weight: 500;
    }

    .reads-info {
      font-size: 0.875rem;
      color: #9ca3af;
      margin-bottom: 10px;
      text-align: center;
    }

    .book-actions {
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }

    .btn-primary {
      padding: 8px 12px;
      border-radius: 8px;
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
      flex-grow: 1;
    }

    .btn-primary:hover {
      background-color: #553c9a;
    }

    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      background-color: #4c3a75;
    }

    .add-to-list {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background-color: rgba(255, 255, 255, 0.1);
      color: #9ca3af;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .add-to-list:hover {
      background-color: var(--primary);
      color: white;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 300px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      background-color: var(--success);
      color: white;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.error {
      background-color: var(--error);
    }

    .notification.success {
      background-color: var(--success);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .section-title {
        font-size: 2rem;
      }
      
      .books-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
      
      .book-image {
        height: 200px;
      }
      
      .filter-btn {
        padding: 6px 12px;
        font-size: 0.875rem;
      }
    }

    @media (max-width: 480px) {
      .books-grid {
        grid-template-columns: 1fr;
      }
      
      .section-title {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M2 17L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M22 17L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>MYM</span> Library
    </div>
    <div class="header-right">
      <div class="language-switcher">
        <button class="language-btn" id="lang-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 12C12 16.4183 12 18 12 18C12 18 12 16.4183 12 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 6V6.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          EN
        </button>
        <div class="language-dropdown" id="lang-dropdown">
          <div class="language-option" data-lang="en">English</div>
          <div class="language-option" data-lang="ar">العربية</div>
          <div class="language-option" data-lang="es">Español</div>
          <div class="language-option" data-lang="fr">Français</div>
          <div class="language-option" data-lang="de">Deutsch</div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="main-content">
      <h1 class="section-title">Explore Our Collection</h1>
      
      <div class="filters" id="filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="fiction">Fiction</button>
        <button class="filter-btn" data-filter="non-fiction">Non-Fiction</button>
        <button class="filter-btn" data-filter="biography">Biography</button>
        <button class="filter-btn" data-filter="science">Science</button>
        <button class="filter-btn" data-filter="history">History</button>
        <button class="filter-btn" data-filter="technology">Technology</button>
        <button class="filter-btn" data-filter="philosophy">Philosophy</button>
      </div>
      
      <div id="books-container" class="books-grid">
        <!-- Books will be loaded here -->
        <div class="loading" id="loading">
          <div class="spinner"></div>
        </div>
      </div>
    </section>
  </main>

  <div class="notification" id="notification"></div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBlOVx-YSmPFeq3lp-gAGe576yG1RhMLYs",
      authDomain: "mymlibraryreads.firebaseapp.com",
      projectId: "mymlibraryreads",
      storageBucket: "mymlibraryreads.firebasestorage.app",
      messagingSenderId: "11947740896",
      appId: "1:11947740896:web:87482eb72210acdba50a85"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let booksData = [];
    let filteredBooks = [];
    let currentFilter = 'all';
    let readBooks = JSON.parse(localStorage.getItem('readBooks')) || [];
    let userData = {
      userId: null,
      readCount: 0
    };

    // DOM elements
    const booksContainer = document.getElementById('books-container');
    const loadingElement = document.getElementById('loading');
    const filtersContainer = document.getElementById('filters');
    const notificationElement = document.getElementById('notification');
    const langBtn = document.getElementById('lang-btn');
    const langDropdown = document.getElementById('lang-dropdown');

    // Language translations
    const translations = {
      en: {
        title: "MYM Library",
        explore: "Explore Our Collection",
        all: "All",
        fiction: "Fiction",
        nonFiction: "Non-Fiction",
        biography: "Biography",
        science: "Science",
        history: "History",
        technology: "Technology",
        philosophy: "Philosophy",
        download: "Download",
        downloaded: "Downloaded",
        downloadAgain: "Download Again",
        reads: "Person Read this Book",
        category: "Category",
        by: "By",
        success: "Success!",
        error: "Error!",
        bookNameMissing: "Book name is missing!",
        fileNotFound: "File not found on server",
        downloadSuccess: "downloaded successfully!",
        downloadFailed: "Failed to download",
        tryAgain: ". Please try again.",
        preparing: "Preparing...",
        addToLibrary: "Add to Library"
      },
      ar: {
        title: "مكتبة MYM",
        explore: "استكشف مجموعتنا",
        all: "الكل",
        fiction: "خيالي",
        nonFiction: "غير خيالي",
        biography: "سيرة ذاتية",
        science: "علم",
        history: "تاريخ",
        technology: "تقنية",
        philosophy: "فلسفة",
        download: "تحميل",
        downloaded: "تم التحميل",
        downloadAgain: "تحميل مرة أخرى",
        reads: "شخص قرأ هذا الكتاب",
        category: "فئة",
        by: "بواسطة",
        success: "نجاح!",
        error: "خطأ!",
        bookNameMissing: "اسم الكتاب مفقود!",
        fileNotFound: "لم يتم العثور على الملف على الخادم",
        downloadSuccess: "تم التحميل بنجاح!",
        downloadFailed: "فشل تحميل",
        tryAgain: ". يرجى المحاولة مرة أخرى.",
        preparing: "جاري التحضير...",
        addToLibrary: "إضافة إلى المكتبة"
      },
      es: {
        title: "Biblioteca MYM",
        explore: "Explora Nuestra Colección",
        all: "Todo",
        fiction: "Ficción",
        nonFiction: "No Ficción",
        biography: "Biografía",
        science: "Ciencia",
        history: "Historia",
        technology: "Tecnología",
        philosophy: "Filosofía",
        download: "Descargar",
        downloaded: "Descargado",
        downloadAgain: "Descargar de nuevo",
        reads: "Persona leyó este libro",
        category: "Categoría",
        by: "Por",
        success: "¡Éxito!",
        error: "¡Error!",
        bookNameMissing: "¡Falta el nombre del libro!",
        fileNotFound: "Archivo no encontrado en el servidor",
        downloadSuccess: "descargado con éxito!",
        downloadFailed: "Falló la descarga",
        tryAgain: ". Por favor, inténtelo de nuevo.",
        preparing: "Preparando...",
        addToLibrary: "Agregar a la biblioteca"
      },
      fr: {
        title: "Bibliothèque MYM",
        explore: "Explorez Notre Collection",
        all: "Tout",
        fiction: "Fiction",
        nonFiction: "Non-Fiction",
        biography: "Biographie",
        science: "Science",
        history: "Histoire",
        technology: "Technologie",
        philosophy: "Philosophie",
        download: "Télécharger",
        downloaded: "Téléchargé",
        downloadAgain: "Télécharger à nouveau",
        reads: "Personne a lu ce livre",
        category: "Catégorie",
        by: "Par",
        success: "Succès !",
        error: "Erreur !",
        bookNameMissing: "Le nom du livre est manquant !",
        fileNotFound: "Fichier introuvable sur le serveur",
        downloadSuccess: "téléchargé avec succès !",
        downloadFailed: "Échec du téléchargement",
        tryAgain: ". Veuillez réessayer.",
        preparing: "Préparation...",
        addToLibrary: "Ajouter à la bibliothèque"
      },
      de: {
        title: "MYM Bibliothek",
        explore: "Entdecken Sie unsere Sammlung",
        all: "Alle",
        fiction: "Fiktion",
        nonFiction: "Nicht-Fiktion",
        biography: "Biografie",
        science: "Wissenschaft",
        history: "Geschichte",
        technology: "Technologie",
        philosophy: "Philosophie",
        download: "Herunterladen",
        downloaded: "Heruntergeladen",
        downloadAgain: "Erneut herunterladen",
        reads: "Person hat dieses Buch gelesen",
        category: "Kategorie",
        by: "Von",
        success: "Erfolg!",
        error: "Fehler!",
        bookNameMissing: "Buchname fehlt!",
        fileNotFound: "Datei nicht auf dem Server gefunden",
        downloadSuccess: "erfolgreich heruntergeladen!",
        downloadFailed: "Herunterladen fehlgeschlagen",
        tryAgain: ". Bitte versuchen Sie es erneut.",
        preparing: "Vorbereitung...",
        addToLibrary: "Zur Bibliothek hinzufügen"
      }
    };

    let currentLang = 'en';

    // Initialize the app
    async function init() {
      try {
        // Load books from Firestore
        await loadBooks();
        
        // Set up event listeners
        setupEventListeners();
        
        // Apply initial filter
        applyFilter(currentFilter);
        
        // Check for read books
        checkReadBooks();
        
      } catch (error) {
        console.error("Initialization error:", error);
        showNotification("Failed to load books. Please refresh the page.", 'error');
        booksContainer.innerHTML = '<div class="loading">Failed to load books. Please refresh the page.</div>';
      }
    }

    // Load books from Firestore
    async function loadBooks() {
      try {
        const booksRef = db.collection("Books");
        const snapshot = await booksRef.get();
        
        booksData = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          booksData.push({
            id: doc.id,
            ...data,
            categories: data.Categories || [],
            section: data.Section || 'general',
            reads: data.Reads || 0
          });
        });
        
        // Sort books by reads (descending)
        booksData.sort((a, b) => b.reads - a.reads);
        
        renderBooks();
        
      } catch (error) {
        console.error("Error loading books:", error);
        throw error;
      }
    }

    // Render books to the DOM
    function renderBooks() {
      if (!booksData || booksData.length === 0) {
        booksContainer.innerHTML = '<div class="loading">No books available.</div>';
        return;
      }
      
      const booksHTML = filteredBooks.map(book => {
        const isRead = readBooks.includes(book.id);
        const badgeClass = book.PurchaseText && book.PurchaseText.includes('FREE') ? 'free' : 'premium';
        const bookType = book.PurchaseText && book.PurchaseText.includes('FREE') ? 'FREE' : 'PREMIUM';
        
        const categoriesHTML = book.categories.map(category => 
          `<span class="category-badge">${category}</span>`
        ).join('');
        
        return `
          <div class="book-card" data-book-id="${book.id}" data-title="${book.Title || 'Untitled'}" data-author="${book.Author || 'Unknown'}" data-categories="${book.categories.join(',').toLowerCase()}">
            <div class="relative">
              <div class="book-type-badge ${badgeClass}">${bookType}</div>
              <div class="book-image">
                <img src="${book.CoverURL || 'https://placehold.co/300x400?text=No+Cover'}" alt="${book.Title || 'Untitled Book'}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-105" />
              </div>
            </div>
            <div class="book-info">
              <h3 class="book-title">${book.Title || 'Untitled Book'}</h3>
              <p class="book-author">By ${book.Author || 'Unknown'}</p>
              <div class="categories">
                ${categoriesHTML}
              </div>
              <div class="reads-info">
                <span>${book.reads} ${translations[currentLang].reads}</span>
              </div>
              <div class="book-actions">
                <button class="btn-primary" ${isRead ? 'disabled' : ''}>
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1">
                    ${isRead ? '<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />' : '<path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />'}
                  </svg>
                  ${isRead ? translations[currentLang].downloaded : translations[currentLang].download}
                </button>
                <button class="add-to-list">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      booksContainer.innerHTML = booksHTML;
      
      // Add event listeners to buttons
      addBookButtonListeners();
    }

    // Add event listeners to book buttons
    function addBookButtonListeners() {
      const downloadButtons = document.querySelectorAll('.btn-primary');
      const addToLibraryButtons = document.querySelectorAll('.add-to-list');
      
      downloadButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
          const bookCard = e.target.closest('.book-card');
          const bookId = bookCard.dataset.bookId;
          const bookTitle = bookCard.dataset.title;
          
          await handleDownload(bookId, bookTitle, button);
        });
      });
      
      addToLibraryButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          const bookCard = e.target.closest('.book-card');
          const bookId = bookCard.dataset.bookId;
          const bookTitle = bookCard.dataset.title;
          
          addToLibrary(bookId, bookTitle);
        });
      });
    }

    // Handle book download
    async function handleDownload(bookId, bookName, buttonEl) {
      if (!bookName) {
        showNotification(translations[currentLang].bookNameMissing, 'error');
        return;
      }

      const wasAlreadyRead = readBooks.includes(bookId);

      try {
        buttonEl.disabled = true;
        buttonEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1 animate-spin"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.702c.043-.553.11-.997.11-1.303 0-.721-.764-1.309-1.719-1.309S9.48 12.778 9.48 13.5c0 .297.07.622.11 1.066-10.088.725-10.931 9.428-10.931 9.428l.11-.001z" /></svg>${translations[currentLang].preparing}`;

        // Download file
        const fileUrl = `/books/${encodeURIComponent(bookName)}.pdf`;
        const response = await fetch(fileUrl, { method: 'HEAD' });
        if (!response.ok) throw new Error(translations[currentLang].fileNotFound);

        const a = document.createElement("a");
        a.href = fileUrl;
        a.download = `${bookName}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        if (!wasAlreadyRead) {
          // Mark as read
          readBooks.push(bookId);
          localStorage.setItem('readBooks', JSON.stringify(readBooks));
          
          // Update book reads count in Firestore
          const bookRef = db.collection("Books").doc(bookId);
          await bookRef.update({ Reads: firebase.firestore.FieldValue.increment(1) });
          
          // Update user data
          if (userData.userId) {
            const userRef = db.collection("Users").doc(userData.userId);
            await userRef.update({ readCount: firebase.firestore.FieldValue.increment(1) });
          }
        }

        // Update button
        buttonEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>${wasAlreadyRead ? translations[currentLang].downloaded : translations[currentLang].downloadAgain}`;
        buttonEl.classList.add("opacity-70", "cursor-not-allowed", "bg-green-600/90", "hover:bg-green-700");

        showNotification(`"${bookName}" ${translations[currentLang].downloadSuccess}`, 'success');
        
        // Add confetti effect
        if (typeof confetti !== 'undefined') {
          confetti({ particleCount: 50, spread: 70, origin: { y: 0.6 } });
        }

        // Refresh the book card to update reads count
        refreshBookCard(bookId);
        
      } catch (err) {
        console.error("Download failed:", err);
        showNotification(`${translations[currentLang].downloadFailed} "${bookName}".${translations[currentLang].tryAgain}`, 'error');
        buttonEl.disabled = false;
        buttonEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>${translations[currentLang].download}`;
        buttonEl.classList.remove("opacity-70", "cursor-not-allowed", "bg-green-600/90", "hover:bg-green-700");
      }
    }

    // Refresh a specific book card after download
    async function refreshBookCard(bookId) {
      const bookRef = db.collection("Books").doc(bookId);
      const doc = await bookRef.get();
      const data = doc.data();
      
      const bookCard = document.querySelector(`[data-book-id="${bookId}"]`);
      if (bookCard) {
        // Update reads count
        const readsInfo = bookCard.querySelector('.reads-info span');
        if (readsInfo) {
          readsInfo.textContent = `${data.Reads || 0} ${translations[currentLang].reads}`;
        }
      }
    }

    // Add book to library
    function addToLibrary(bookId, bookTitle) {
      showNotification(`"${bookTitle}" ${translations[currentLang].addToLibrary}`, 'success');
    }

    // Check which books have been read
    function checkReadBooks() {
      const bookCards = document.querySelectorAll('.book-card');
      
      bookCards.forEach(card => {
        const bookId = card.dataset.bookId;
        const isRead = readBooks.includes(bookId);
        
        if (isRead) {
          const downloadButton = card.querySelector('.btn-primary');
          if (downloadButton) {
            downloadButton.disabled = true;
            downloadButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>${translations[currentLang].downloaded}`;
            downloadButton.classList.add("opacity-70", "cursor-not-allowed", "bg-green-600/90", "hover:bg-green-700");
          }
        }
      });
    }

    // Apply filter to books
    function applyFilter(filter) {
      currentFilter = filter;
      
      if (filter === 'all') {
        filteredBooks = [...booksData];
      } else {
        filteredBooks = booksData.filter(book => {
          return book.categories.some(cat => cat.toLowerCase().includes(filter.toLowerCase())) ||
                 book.section.toLowerCase().includes(filter.toLowerCase());
        });
      }
      
      renderBooks();
    }

    // Setup event listeners
    function setupEventListeners() {
      // Filter buttons
      const filterButtons = document.querySelectorAll('.filter-btn');
      filterButtons.forEach(button => {
        button.addEventListener('click', () => {
          filterButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          applyFilter(button.dataset.filter);
        });
      });
      
      // Language switcher
      langBtn.addEventListener('click', () => {
        langDropdown.classList.toggle('show');
      });
      
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.language-switcher')) {
          langDropdown.classList.remove('show');
        }
      });
      
      const languageOptions = document.querySelectorAll('.language-option');
      languageOptions.forEach(option => {
        option.addEventListener('click', () => {
          const lang = option.dataset.lang;
          changeLanguage(lang);
          langDropdown.classList.remove('show');
        });
      });
    }

    // Change language
    function changeLanguage(lang) {
      currentLang = lang;
      langBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 12C12 16.4183 12 18 12 18C12 18 12 16.4183 12 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 6V6.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      ${lang.toUpperCase()}`;
      
      // Update UI elements with new language
      document.querySelector('.section-title').textContent = translations[currentLang].explore;
      
      const filterButtons = document.querySelectorAll('.filter-btn');
      filterButtons.forEach(button => {
        const filter = button.dataset.filter;
        if (filter === 'all') button.textContent = translations[currentLang].all;
        else if (filter === 'fiction') button.textContent = translations[currentLang].fiction;
        else if (filter === 'non-fiction') button.textContent = translations[currentLang].nonFiction;
        else if (filter === 'biography') button.textContent = translations[currentLang].biography;
        else if (filter === 'science') button.textContent = translations[currentLang].science;
        else if (filter === 'history') button.textContent = translations[currentLang].history;
        else if (filter === 'technology') button.textContent = translations[currentLang].technology;
        else if (filter === 'philosophy') button.textContent = translations[currentLang].philosophy;
      });
      
      // Re-render books to update text
      renderBooks();
    }

    // Show notification
    function showNotification(message, type = 'success') {
      notificationElement.textContent = message;
      notificationElement.className = `notification ${type}`;
      notificationElement.classList.add('show');
      
      setTimeout(() => {
        notificationElement.classList.remove('show');
      }, 3000);
    }

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

