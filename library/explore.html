<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Browse and explore our collection of the best and most popular books available in MYM Library." />
  <link rel="icon" href="icon.ico" type="image/x-icon" />
  <title>MYM Library - Explore Books</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  
  <style>
    /* All CSS styles as in previous version - unchanged */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --color-primary: #3b82f6;
      --color-primary-dark: #2563eb;
      --color-secondary: #8b5cf6;
      --color-accent: #f59e0b;
      --bg-dark: #0f172a;
      --bg-dark-light: #1e293b;
      --text-light: #f1f5f9;
      --text-gray: #94a3b8;
      --border-color: #334155;
      --card-bg: #1e293b;
      --shadow-color: rgba(0, 0, 0, 0.3);
    }
    
    html.dark {
      background-color: var(--bg-dark);
      color: var(--text-light);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
      width: 100%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4);
    }
    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
    }
    .btn-primary svg {
      margin-right: 8px;
    }
    
    /* All other CSS styles from previous version remain unchanged */
    .book-type-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      font-weight: 600;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 20px;
      z-index: 5;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    
    .book-type-badge-member {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }
    
    .book-type-badge-reader {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }
    
    .sidebar {
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1);
      z-index: 40;
      box-shadow: 5px 0 25px rgba(0, 0, 0, 0.2);
      height: 100vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 #1e293b;
    }
    
    .sidebar::-webkit-scrollbar {
      width: 8px;
    }
    
    .sidebar::-webkit-scrollbar-track {
      background: #1e293b;
    }
    
    .sidebar::-webkit-scrollbar-thumb {
      background-color: #4b5563;
      border-radius: 10px;
    }
    
    .sidebar.open {
      transform: translateX(0);
    }
    
    .user-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    .book-card {
      background: var(--card-bg);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      border: 1px solid var(--border-color);
      will-change: transform, box-shadow;
    }
    
    .book-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35);
      border-color: #4b5563;
    }
    
    .book-list-item {
      border-bottom: 1px solid var(--border-color);
      padding: 14px 0;
      transition: all 0.2s ease;
    }
    
    .book-list-item:hover {
      background: rgba(59, 130, 246, 0.1);
      border-radius: 10px;
      padding-left: 8px;
    }
    
    .filter-badge {
      transition: all 0.3s ease;
      border-radius: 50px;
      padding: 6px 16px;
      font-weight: 500;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 36px;
    }
    
    .filter-badge.active {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      transform: translateY(-2px);
    }
    
    .filter-badge:hover:not(.active) {
      background: rgba(59, 130, 246, 0.15);
      transform: translateY(-1px);
    }
    
    .language-toggle {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .language-toggle:hover {
      transform: scale(1.1);
    }
    
    .search-container {
      position: relative;
      transition: all 0.3s ease;
    }
    
    .search-input {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-color);
      color: white;
      padding: 9px 18px;
      border-radius: 50px;
      width: 0;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
      margin-left: -16px;
    }
    
    .search-input.active {
      width: 240px;
      opacity: 1;
      margin-left: 0;
    }
    
    .search-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
      transition: color 0.2s ease;
    }
    
    .search-container:hover .search-icon {
      color: white;
    }
    
    .no-books-message {
      display: none;
      text-align: center;
      padding: 40px 20px;
      color: #94a3b8;
    }
    
    .sidebar-empty .no-books-message {
      display: block;
    }
    
    .sidebar-empty .book-list-content {
      display: none;
    }
    
    .floating-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 50;
      width: 65px;
      height: 65px;
      border-radius: 20px;
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      cursor: pointer;
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
      70% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
      100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }
    
    .floating-btn:hover {
      transform: scale(1.1) rotate(3deg);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
    }
    
    .floating-btn svg {
      width: 30px;
      height: 30px;
      color: white;
    }
    
    .notification {
      position: fixed;
      bottom: 30px;
      right: 110px;
      z-index: 60;
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      padding: 14px 22px;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transform: translateX(150%);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
      border-left: 4px solid var(--color-primary);
      font-weight: 500;
      display: flex;
      align-items: center;
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification svg {
      margin-right: 10px;
      color: var(--color-primary);
    }
    
    .category-badge {
      transition: all 0.2s ease;
      height: 26px;
    }
    
    .category-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 300px;
      width: 100%;
    }
    
    .spinner {
      width: 56px;
      height: 56px;
      border: 6px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ... (rest of CSS styles remain unchanged from previous version) ... */
    
    @media (max-width: 1024px) {
      .sidebar {
        width: 320px;
      }
      
      .search-input.active {
        width: 200px;
      }
    }
    
    @media (max-width: 768px) {
      .books-grid {
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)) !important;
      }
      
      .filters-container {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .filter-badge {
        padding: 6px 12px;
        font-size: 0.85rem;
      }
      
      .search-input.active {
        width: 170px;
      }
      
      .header-actions {
        gap: 8px;
      }
      
      .floating-btn {
        width: 55px;
        height: 55px;
        bottom: 25px;
        right: 25px;
      }
      
      .notification {
        right: 95px;
        bottom: 25px;
        max-width: 250px;
        font-size: 0.9rem;
        padding: 12px 18px;
      }
    }
    
    @media (max-width: 640px) {
      .search-input.active {
        width: 140px;
      }
      
      .sidebar {
        width: 300px;
      }
      
      .books-grid {
        grid-template-columns: 1fr !important;
      }
      
      .header-title {
        font-size: 1.5rem;
      }
      
      .floating-btn {
        width: 50px;
        height: 50px;
        bottom: 20px;
        right: 20px;
      }
      
      .notification {
        display: none;
      }
      
      .leaderboard-mobile {
        display: block;
      }
      
      .leaderboard-desktop {
        display: none;
      }
      
      .search-container {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      .header-actions {
        gap: 4px;
      }
      
      .search-input.active {
        width: 120px;
      }
      
      .floating-btn {
        width: 45px;
        height: 45px;
      }
      
      .books-header {
        font-size: 1.6rem;
      }
      
      .btn-primary {
        padding: 0.7rem 1.2rem;
        font-size: 0.9rem;
      }
      
      .floating-btn svg {
        width: 25px;
        height: 25px;
      }
    }
    
    @media (max-width: 380px) {
      .search-input.active {
        width: 100%;
      }
      
      .user-avatar {
        width: 8px;
        height: 8px;
      }
      
      .user-name {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

<header class="fixed top-0 left-0 w-full bg-gray-900/80 backdrop-blur-sm border-b border-gray-800 z-50">
  <nav class="container mx-auto px-4 py-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="relative">
          <div class="w-10 h-10 rounded-xl bg-blue-600/90 flex items-center justify-center backdrop-blur-sm">
            <span class="text-xl font-bold text-white tracking-tight">MYM</span>
          </div>
          <span class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-gray-900"></span>
        </div>
        <h1 class="header-title text-xl md:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
          MYM Library
        </h1>
      </div>
      
      <div class="flex items-center gap-3 header-actions">
        <div class="search-container relative">
          <input id="search-input" type="search" placeholder="Search books..." class="search-input focus:outline-none focus:ring-2 focus:ring-blue-500">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="search-icon w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A2.25 2.25 0 0113.5 15.75l-2.697.343m-2.697.343a2.25 2.25 0 01-1.91-1.91L6.25 12H4.5m4.06-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91-1.91L2.25 6.75 4.5 4.5m4.06-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L2.25 7.5 4.5 9.75m14.25-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L15.75 12h-3.375m-2.193-1.51l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L9 15.75V18m3.06-12.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L9 12.75v2.032c0 .418.336.754.754.754h4.082c.418 0 .754-.336.754-.754V12.75c0-.418-.336-.754-.754-.754h-1.082a2.25 2.25 0 00-1.91 1.91z" />
          </svg>
        </div>
        
        <button id="search-toggle" class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-800 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A2.25 2.25 0 0113.5 15.75l-2.697.343m-2.697.343a2.25 2.25 0 01-1.91-1.91L6.25 12H4.5m4.06-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91-1.91L2.25 6.75 4.5 4.5m4.06-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L2.25 7.5 4.5 9.75m14.25-2.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L15.75 12h-3.375m-2.193-1.51l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L9 15.75V18m3.06-12.193l-1.51 1.51m0 0a2.25 2.25 0 01-1.91 1.91L9 12.75v2.032c0 .418.336.754.754.754h4.082c.418 0 .754-.336.754-.754V12.75c0-.418-.336-.754-.754-.754h-1.082a2.25 2.25 0 00-1.91 1.91z" />
          </svg>
        </button>
        
        <button id="language-toggle" class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-800 transition-colors">
          <span class="en font-medium flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75a1.5 1.5 0 010 3H19.5m-3.75 0a1.5 1.5 0 000-3" />
            </svg>
            EN
          </span>
          <span class="ar hidden font-medium flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75a1.5 1.5 0 010 3H19.5m-3.75 0a1.5 1.5 0 000-3" />
            </svg>
            AR
          </span>
        </button>
        
        <button id="sidebar-toggle" class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-gray-800 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
        </button>
        
        <button id="leaderboard-toggle" class="leaderboard-desktop bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200 shadow-lg hover:shadow-xl">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1 -mt-0.5 inline">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.504-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 01-.982-3.172M9.497 14.25a7.454 7.454 0 00.981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 007.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 002.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492c.962-.203 1.934-.377 2.916-.52" />
          </svg>
          Leaderboard
        </button>
      </div>
    </div>
  </nav>
</header>

<!-- Sidebar for book list -->
<div id="sidebar" class="sidebar fixed top-0 left-0 bg-gray-800/90 backdrop-blur-lg z-40 flex flex-col">
  <div class="p-4 md:p-5 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-800/95 backdrop-blur-sm z-10">
    <div class="flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-blue-400 mr-2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.987 8.987 0 00-6 2.292m0-14.25v14.25" />
      </svg>
      <h2 class="text-lg md:text-xl font-bold text-white">Reading List</h2>
    </div>
    <button id="sidebar-close" class="text-gray-400 hover:text-white p-1.5 hover:bg-gray-700 rounded-lg transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
  
  <div class="p-4 md:p-5 overflow-y-auto flex-1">
    <div class="user-card p-4 mb-6">
      <div class="flex items-center">
        <div class="w-12 h-12 rounded-xl bg-blue-600/90 flex items-center justify-center font-bold text-white text-xl mr-3 backdrop-blur-sm">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <div>
          <h3 id="user-name" class="font-bold text-lg md:text-xl">User</h3>
          <div class="flex items-center mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-blue-400 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.987 8.987 0 00-6 2.292m0-14.25v14.25" />
            </svg>
            <p id="user-read-count" class="text-blue-400 text-sm md:text-base">0 books read</p>
          </div>
        </div>
      </div>
      
      <div class="mt-4 pt-3 border-t border-gray-700">
        <p class="text-gray-400 mb-1 text-sm">Email:</p>
        <p id="user-email" class="text-gray-300 text-sm break-all">user@example.com</p>
      </div>
    </div>
    
    <div class="sidebar-empty">
      <div class="no-books-message">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto mb-2 text-gray-600">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
        </svg>
        <p class="font-medium text-lg">Your reading list is empty</p>
        <p class="text-sm text-gray-400 mt-2">Add books by clicking the <span class="inline-block mx-1">+</span> button on any book card</p>
      </div>
      
      <div class="book-list-content mt-6">
        <div id="book-list" class="space-y-3">
          <!-- Books will be added here -->
        </div>
      </div>
      
      <div class="mt-6 pt-4 border-t border-gray-700">
        <button id="download-all" class="btn-primary mb-3 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
          Download All
        </button>
        <button id="clear-list" class="w-full py-3 rounded-xl font-medium transition-colors bg-gray-700 hover:bg-gray-600 text-white flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
          </svg>
          Clear List
        </button>
      </div>
    </div>
  </div>
</div>

<!-- User info popup -->
<div id="user-popup" class="modal-overlay hidden">
  <div class="modal-content bg-gray-800/90 backdrop-blur-xl rounded-2xl p-5 md:p-6 md:max-w-md w-full mx-4 shadow-2xl border border-gray-700 relative overflow-hidden">
    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-purple-600"></div>
    <div class="flex items-center mb-6">
      <div class="w-16 h-16 rounded-2xl bg-blue-600/90 flex items-center justify-center text-white font-bold text-3xl mr-4 backdrop-blur-sm">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-9 h-9">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </div>
      <div>
        <h3 id="popup-user-name" class="font-bold text-xl md:text-2xl text-white">User</h3>
        <div class="flex items-center mt-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-blue-400 mr-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.987 8.987 0 00-6 2.292m0-14.25v14.25" />
          </svg>
          <p id="popup-user-read-count" class="text-blue-400 text-lg">0 books read</p>
        </div>
      </div>
    </div>
    
    <div class="border-t border-gray-700 pt-4">
      <div class="mb-4">
        <p class="text-gray-400 mb-1 text-sm">Email:</p>
        <p id="popup-user-email" class="text-gray-300 break-all text-lg font-mono">user@example.com</p>
      </div>
      
      <div class="text-center mt-6">
        <button id="close-popup" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 shadow-lg hover:shadow-xl flex items-center mx-auto">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Continue to Library
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container mx-auto mt-24 px-4 pb-10">
  <h1 class="books-header text-2xl md:text-3xl font-bold mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-600">
    Explore Our Collection
  </h1>
  
  <div class="flex justify-center mb-8">
    <div class="filters-container flex flex-wrap justify-center gap-3 max-w-5xl">
      <span class="filter-badge bg-blue-500/20 text-blue-300 active">All</span>
      <span class="filter-badge bg-gray-800 text-gray-300 hover:bg-gray-700">Fiction</span>
      <span class="filter-badge bg-gray-800 text-gray-300 hover:bg-gray-700">Non-Fiction</span>
      <span class="filter-badge bg-gray-800 text-gray-300 hover:bg-gray-700">Biography</span>
      <span class="filter-badge bg-gray-800 text-gray-300 hover:bg-gray-700">Science</span>
      <span class="filter-badge bg-gray-800 text-gray-300 hover:bg-gray-700">History</span>
      <span class="filter-badge bg-gray-800 text-gray-300 hover:bg-gray-700">Technology</span>
      <span class="filter-badge bg-gray-800 text-gray-300 hover:bg-gray-700">Philosophy</span>
    </div>
  </div>

  <!-- Books grid -->
  <div id="books-grid" class="books-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto">
    <!-- Books will be loaded here -->
    <div class="loader col-span-full">
      <div class="spinner"></div>
    </div>
  </div>
  
  <div class="notification" id="notification">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    Book added to your list
  </div>
</div>

<!-- Floating buttons -->
<div class="floating-btn md:hidden" id="mobile-sidebar-toggle">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
  </svg>
</div>

<div class="floating-btn md:hidden leaderboard-mobile" id="mobile-leaderboard-toggle" style="right: 100px; bottom: 30px;">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.504-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 01-.982-3.172M9.497 14.25a7.454 7.454 0 00.981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 007.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 002.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492c.962-.203 1.934-.377 2.916-.52" />
  </svg>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBlOVx-YSmPFeq3lp-gAGe576yG1RhMLYs",
    authDomain: "mymlibraryreads.firebaseapp.com",
    projectId: "mymlibraryreads",
    storageBucket: "mymlibraryreads.firebasestorage.app",
    messagingSenderId: "11947740896",
    appId: "1:11947740896:web:87482eb72210acdba50a85"
  };

  // Initialize Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const auth = firebase.auth();
  const db = firebase.firestore();
  const booksCollection = db.collection("Books");

  // User data
  let userData = {
    userId: null,
    name: "User",
    email: "user@example.com",
    readCount: 0
  };

  let bookList = getBookList(); // ✅ تهيئة مبكرة
  let lastSearchQuery = '';
  let debouncingSearch = null;
  let booksLoaded = false; // ✅ تتبع حالة التحميل

  // Initialize app
  function initApp() {
    // Show loader
    document.getElementById('books-grid').innerHTML = `
      <div class="loader col-span-full">
        <div class="spinner"></div>
      </div>
    `;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        try {
          await fetchOrCreateUser(user);
          if (!booksLoaded) {
            loadBooks();
          }
        } catch (err) {
          console.error("Auth error:", err);
          alert("حدث خطأ في تسجيل الدخول. يرجى إعادة المحاولة.");
          window.location.href = "/library/login";
        }
      } else {
        window.location.href = "/library/login";
      }
    });
  }

  async function fetchOrCreateUser(user) {
    const userRef = db.collection("Users").doc(user.uid);
    const doc = await userRef.get();

    if (doc.exists) {
      const data = doc.data();
      userData = {
        userId: user.uid,
        name: data.name || user.displayName || "User",
        email: data.email || user.email || "user@example.com",
        readCount: data.readCount || 0
      };
    } else {
      // Create new user
      userData = {
        userId: user.uid,
        name: user.displayName || user.email.split('@')[0],
        email: user.email,
        readCount: 0
      };
      await userRef.set({
        name: userData.name,
        email: userData.email,
        readCount: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    // Update UI
    updateUIWithUserData();
    showUserPopup();
  }

  function updateUIWithUserData() {
    document.getElementById('user-name').textContent = userData.name;
    document.getElementById('user-read-count').textContent = `${userData.readCount} books read`;
    document.getElementById('user-email').textContent = userData.email;
    document.getElementById('popup-user-name').textContent = userData.name;
    document.getElementById('popup-user-read-count').textContent = `${userData.readCount} books read`;
    document.getElementById('popup-user-email').textContent = userData.email;
  }

  function showUserPopup() {
    setTimeout(() => {
      const popup = document.getElementById('user-popup');
      popup.classList.remove('hidden');
      // No 'open' class needed unless animated via CSS
    }, 300);
  }

  function loadBooks() {
    booksCollection.onSnapshot(
      (snapshot) => {
        const booksGrid = document.getElementById('books-grid');
        // ✅ تأكد من إزالة الـ loader مرة واحدة فقط
        if (!booksLoaded) {
          const loader = booksGrid.querySelector('.loader');
          if (loader) loader.remove();
          booksLoaded = true;
        }

        if (snapshot.empty) {
          booksGrid.innerHTML = `
            <div class="text-center py-16 col-span-full fade-in">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto text-gray-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.987 8.987 0 00-6 2.292m0-14.25v14.25" />
              </svg>
              <h3 class="text-xl font-bold mb-2 text-white">No books available</h3>
              <p class="text-gray-400 mb-6 max-w-md mx-auto">Our library is currently being updated with new books. Please check back soon!</p>
              <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition-all duration-300 flex items-center mx-auto" onclick="location.reload()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.702c.043-.553.11-.997.11-1.303 0-.721-.764-1.309-1.719-1.309S9.48 12.778 9.48 13.5c0 .297.07.622.11 1.066-10.088.725-10.931 9.428-10.931 9.428l.11-.001z" />
                </svg>
                Refresh Library
              </button>
            </div>
          `;
          return;
        }

        // Render each book
        snapshot.docs.forEach(doc => {
          renderBook(doc);
        });
      },
      (error) => {
        console.error("Firestore books load error:", error);
        document.getElementById("books-grid").innerHTML = `
          <div class="text-center py-16 col-span-full fade-in">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto text-red-500">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
            </svg>
            <h3 class="text-xl font-bold mb-2 text-white">Connection Error</h3>
            <p class="text-gray-400 mb-6 max-w-md mx-auto">Failed to load books. Please check your internet connection.</p>
            <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition-all duration-300 flex items-center mx-auto" onclick="location.reload()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.702c.043-.553.11-.997.11-1.303 0-.721-.764-1.309-1.719-1.309S9.48 12.778 9.48 13.5c0 .297.07.622.11 1.066-10.088.725-10.931 9.428-10.931 9.428l.11-.001z" />
              </svg>
              Retry
            </button>
          </div>
        `;
      }
    );
  }

  function renderBook(doc) {
    const data = doc.data();
    const booksGrid = document.getElementById("books-grid");
    const existingCard = booksGrid.querySelector(`.book-card[data-book-id="${doc.id}"]`);
    if (existingCard) return; // ✅ تجنب التكرار

    let categories = [];
    if (Array.isArray(data.Categories)) {
      categories = data.Categories;
    } else if (typeof data.Categories === "string") {
      categories = data.Categories.split(",").map(c => c.trim()).filter(Boolean);
    }

    const bookType = data.Section === "members" ? "member" : "reader";
    const badgeClass = bookType === "member" ? "book-type-badge-member" : "book-type-badge-reader";
    const readBooks = getReadBooks();
    const isRead = readBooks.includes(doc.id);

    const bookCard = document.createElement("div");
    bookCard.className = "book-card relative fade-in";
    bookCard.dataset.bookId = doc.id;
    bookCard.dataset.title = data.Title || "Untitled";
    bookCard.dataset.author = data.Author || "Unknown";
    bookCard.dataset.categories = categories.join(",").toLowerCase();

    bookCard.innerHTML = `
      <div class="relative">
        <div class="book-type-badge ${badgeClass}">${bookType}</div>
        <div class="h-56 overflow-hidden">
          <img src="${data.CoverURL || 'placeholder.jpg'}" alt="${data.Title}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-105" />
        </div>
      </div>
      <div class="p-4">
        <h3 class="font-bold text-lg mb-1.5 line-clamp-2">${data.Title || "Untitled Book"}</h3>
        <p class="text-gray-300 mb-3 text-sm line-clamp-1 font-medium">By ${data.Author || "Unknown"}</p>
        <div class="flex flex-wrap gap-2 mb-4">
          ${categories.map(c => `<span class="category-badge px-2.5 py-1 bg-gray-800/70 text-blue-300 rounded-xl text-xs font-medium">${c}</span>`).join("")}
        </div>
        <div class="flex gap-2">
          <button class="btn-primary" ${isRead ? 'disabled' : ''}>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1">
              ${isRead ? '<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />' : '<path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />'}
            </svg>
            ${isRead ? 'Downloaded' : 'Download'}
          </button>
          <button class="add-to-list w-10 h-10 rounded-xl bg-gray-800/70 flex items-center justify-center text-gray-300 hover:bg-blue-600/90 hover:text-white transition-all duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
          </button>
        </div>
      </div>
    `;

    booksGrid.appendChild(bookCard);

    // Download button
    const downloadBtn = bookCard.querySelector(".btn-primary");
    downloadBtn.addEventListener("click", () => {
      handleDownload(doc.id, data.Title, downloadBtn);
    });

    // Add to list
    const addBtn = bookCard.querySelector(".add-to-list");
    addBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      addToBookList({
        id: doc.id,
        title: data.Title,
        author: data.Author,
        coverURL: data.CoverURL
      });
      // Confetti & visual feedback (same as before)
      addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 animate-pulse"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
      addBtn.classList.replace("bg-gray-800/70", "bg-green-600/90");
      addBtn.classList.replace("text-gray-300", "text-white");
      confetti({ particleCount: 20, spread: 70, origin: { x: e.clientX / window.innerWidth, y: e.clientY / window.innerHeight } });
      setTimeout(() => {
        addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`;
        addBtn.classList.replace("bg-green-600/90", "bg-gray-800/70");
        addBtn.classList.replace("text-white", "text-gray-300");
      }, 1500);
    });
  }

  // =============== دوال المساعدة ===============
  function getBookList() {
    try {
      return JSON.parse(localStorage.getItem("bookList") || "[]");
    } catch {
      return [];
    }
  }

  function setBookList(books) {
    localStorage.setItem("bookList", JSON.stringify(books));
    bookList = books;
    updateBookListUI();
  }

  function addToBookList(book) {
    if (!bookList.some(b => b.id === book.id)) {
      bookList.push(book);
      setBookList(bookList);
      showNotification(`Added "${book.title}" to your list`, 'success');
    }
  }

  function removeFromBookList(bookId) {
    bookList = bookList.filter(b => b.id !== bookId);
    setBookList(bookList);
  }

  function clearBookList() {
    bookList = [];
    setBookList(bookList);
  }

  function getReadBooks() {
    try {
      return JSON.parse(localStorage.getItem("readBooks") || "[]");
    } catch {
      return [];
    }
  }

  function setReadBooks(books) {
    localStorage.setItem("readBooks", JSON.stringify(books));
  }

  function updateBookListUI() {
    const bookListEl = document.getElementById('book-list');
    const sidebar = document.getElementById('sidebar');
    if (bookList.length === 0) {
      sidebar.classList.add('sidebar-empty');
    } else {
      sidebar.classList.remove('sidebar-empty');
      bookListEl.innerHTML = bookList.map(book => `
        <div class="book-list-item fade-in">
          <div class="flex items-center">
            <img src="${book.coverURL || 'placeholder.jpg'}" alt="${book.title}" class="w-12 h-12 object-cover rounded-xl mr-3 border border-gray-700">
            <div class="flex-1 min-w-0">
              <h4 class="text-sm md:text-base font-medium truncate">${book.title}</h4>
              <p class="text-xs md:text-sm text-gray-400 truncate">by ${book.author}</p>
            </div>
            <button data-book-id="${book.id}" class="remove-from-list text-gray-400 hover:text-red-500 p-1.5 hover:bg-red-500/10 rounded-lg transition-all duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('.remove-from-list').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const bookId = e.currentTarget.dataset.bookId;
          removeFromBookList(bookId);
          showNotification("Book removed from list", 'info');
        });
      });
    }
  }

  function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        ${type === 'success' ?
          '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l2.25 2.25 4.5-4.5m0 0l-1.5-1.5M7.5 15l1.5-1.5m3 3l1.5-1.5m-4.5 0l1.5 1.5m3-3l-1.5 1.5" />' :
          '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'}
      </svg>
      ${message}
    `;
    notification.className = 'notification ' + (type === 'success' ? 'border-green-500' : 'border-blue-500');
    notification.querySelector('svg').classList.add(type === 'success' ? 'text-green-500' : 'text-blue-500');
    notification.classList.add('show');
    setTimeout(() => notification.classList.remove('show'), 3500);
  }

  async function handleDownload(bookId, bookName, buttonEl) {
    if (!bookName) {
      showNotification("Book name is missing!", 'error');
      return;
    }

    const readBooks = getReadBooks();
    const wasAlreadyRead = readBooks.includes(bookId);

    try {
      buttonEl.disabled = true;
      buttonEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1 animate-spin"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.702c.043-.553.11-.997.11-1.303 0-.721-.764-1.309-1.719-1.309S9.48 12.778 9.48 13.5c0 .297.07.622.11 1.066-10.088.725-10.931 9.428-10.931 9.428l.11-.001z" /></svg>Preparing...`;

      // Download file
      const fileUrl = `/library/books/${encodeURIComponent(bookName)}.pdf`;
      const response = await fetch(fileUrl, { method: 'HEAD' });
      if (!response.ok) throw new Error('File not found on server');

      const a = document.createElement("a");
      a.href = fileUrl;
      a.download = `${bookName}.pdf`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      if (!wasAlreadyRead) {
        // Mark as read
        readBooks.push(bookId);
        setReadBooks(readBooks);
        userData.readCount++;
        updateReadCounterUI();

        // Update Firestore
        await db.collection("Books").doc(bookId).update({ Reads: firebase.firestore.FieldValue.increment(1) });
        if (userData.userId) {
          await db.collection("Users").doc(userData.userId).update({ readCount: firebase.firestore.FieldValue.increment(1) });
        }
      }

      // Update button
      buttonEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>${wasAlreadyRead ? 'Downloaded' : 'Download Again'}`;
      buttonEl.classList.add("opacity-70", "cursor-not-allowed", "bg-green-600/90", "hover:bg-green-700");

      showNotification(`"${bookName}" downloaded successfully!`, 'success');
      confetti({ particleCount: 50, spread: 70, origin: { y: 0.6 } });

    } catch (err) {
      console.error("Download failed:", err);
      showNotification(`Failed to download "${bookName}". Please try again.`, 'error');
      buttonEl.disabled = false;
      buttonEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>Download`;
      buttonEl.classList.remove("opacity-70", "cursor-not-allowed", "bg-green-600/90", "hover:bg-green-700");
    }
  }

  function updateReadCounterUI() {
    document.getElementById('user-read-count').textContent = `${userData.readCount} books read`;
    document.getElementById('popup-user-read-count').textContent = `${userData.readCount} books read`;
  }

  function searchBooks(query) {
    query = query.trim().toLowerCase();
    document.querySelectorAll(".book-card").forEach(book => {
      if (query === "") {
        book.style.display = "block";
      } else {
        const title = (book.dataset.title || "").toLowerCase();
        const author = (book.dataset.author || "").toLowerCase();
        const categories = (book.dataset.categories || "").toLowerCase();
        book.style.display = (title.includes(query) || author.includes(query) || categories.includes(query)) ? "block" : "none";
      }
    });
  }

  function applyFilters() {
    const activeFilter = document.querySelector('.filter-badge.active');
    const filterName = activeFilter ? activeFilter.textContent.trim().toLowerCase() : 'all';
    document.querySelectorAll(".book-card").forEach(book => {
      if (filterName === 'all') {
        book.style.display = "block";
      } else {
        const categories = (book.dataset.categories || "").toLowerCase();
        book.style.display = categories.includes(filterName) ? "block" : "none";
      }
    });
  }

  // =============== ربط الأحداث ===============
  initApp();
  updateBookListUI(); // تأكد من تحديث القائمة عند التشغيل

  // Search
  const searchInput = document.getElementById("search-input");
  const searchToggle = document.getElementById("search-toggle");
  searchToggle.addEventListener("click", () => {
    searchInput.classList.toggle("active");
    if (searchInput.classList.contains("active")) searchInput.focus();
  });
  searchInput.addEventListener("input", (e) => {
    clearTimeout(debouncingSearch);
    debouncingSearch = setTimeout(() => {
      if (e.target.value !== lastSearchQuery) {
        lastSearchQuery = e.target.value;
        searchBooks(lastSearchQuery);
      }
    }, 300);
  });

  // Close search on outside click
  document.addEventListener("click", (e) => {
    const container = document.querySelector(".search-container");
    if (!container.contains(e.target) && searchInput.classList.contains("active")) {
      searchInput.classList.remove("active");
    }
  });

  // Filters
  document.querySelectorAll('.filter-badge').forEach(badge => {
    badge.addEventListener('click', function () {
      document.querySelectorAll('.filter-badge').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      applyFilters();
    });
  });

  // Sidebar
  ["sidebar-toggle", "mobile-sidebar-toggle", "sidebar-close"].forEach(id => {
    document.getElementById(id)?.addEventListener("click", () => {
      document.getElementById("sidebar").classList.toggle("open", id !== "sidebar-close");
    });
  });

  // Close sidebar on outside click (mobile)
  document.addEventListener("click", (e) => {
    const sidebar = document.getElementById("sidebar");
    if (sidebar.classList.contains("open") &&
        !sidebar.contains(e.target) &&
        !["sidebar-toggle", "mobile-sidebar-toggle"].some(id => document.getElementById(id)?.contains(e.target))) {
      sidebar.classList.remove("open");
    }
  });

  // Download all
  document.getElementById("download-all")?.addEventListener("click", async () => {
    if (bookList.length === 0) {
      showNotification("Your reading list is empty", 'info');
      return;
    }
    showNotification(`Starting download of ${bookList.length} books...`, 'info');
    const readBooks = getReadBooks();
    let newBooks = 0;

    for (const book of bookList) {
      await new Promise(resolve => setTimeout(resolve, 200)); // تأخير بسيط
      try {
        const fileUrl = `/library/books/${encodeURIComponent(book.title)}.pdf`;
        const res = await fetch(fileUrl, { method: 'HEAD' });
        if (res.ok) {
          const a = document.createElement("a");
          a.href = fileUrl;
          a.download = `${book.title}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          if (!readBooks.includes(book.id)) {
            readBooks.push(book.id);
            newBooks++;
          }
        }
      } catch (err) {
        console.warn(`Failed to download: ${book.title}`, err);
      }
    }

    // Update read status
    if (newBooks > 0) {
      setReadBooks(readBooks);
      userData.readCount += newBooks;
      updateReadCounterUI();
      await db.collection("Users").doc(userData.userId).update({ readCount: firebase.firestore.FieldValue.increment(newBooks) });
    }

    clearBookList();
    showNotification(`Downloaded ${bookList.length} books!`, 'success');
    confetti({ particleCount: 100, spread: 120, origin: { y: 0.6 } });
  });

  // Clear list
  document.getElementById("clear-list")?.addEventListener("click", () => {
    if (bookList.length && confirm(`Clear ${bookList.length} books from your list?`)) {
      clearBookList();
      showNotification("Reading list cleared", 'info');
    }
  });

  // Close popup
  document.getElementById("close-popup")?.addEventListener("click", () => {
    document.getElementById("user-popup").classList.add("hidden");
  });

  // Language toggle
  document.getElementById("language-toggle")?.addEventListener("click", () => {
    const en = document.querySelector('.en');
    const ar = document.querySelector('.ar');
    const isArabic = !en.classList.contains('hidden');
    if (isArabic) {
      // Switch to English
      en.classList.remove('hidden');
      ar.classList.add('hidden');
      document.documentElement.setAttribute('dir', 'ltr');
      document.documentElement.lang = 'en';
      // Update text
      document.getElementById('user-read-count').textContent = `${userData.readCount} books read`;
      document.getElementById('popup-user-read-count').textContent = `${userData.readCount} books read`;
    } else {
      // Switch to Arabic
      en.classList.add('hidden');
      ar.classList.remove('hidden');
      document.documentElement.setAttribute('dir', 'rtl');
      document.documentElement.lang = 'ar';
      document.getElementById('user-read-count').textContent = `قرأت ${userData.readCount} كتاب`;
      document.getElementById('popup-user-read-count').textContent = `قرأت ${userData.readCount} كتاب`;
    }
  });

  // Leaderboard
  function navigateToLeaderboard() {
    if (userData.userId) {
      window.location.href = `/library/leadboard?userId=${encodeURIComponent(userData.userId)}`;
    } else {
      window.location.href = "/library/login";
    }
  }
  ["leaderboard-toggle", "mobile-leaderboard-toggle"].forEach(id => {
    document.getElementById(id)?.addEventListener("click", navigateToLeaderboard);
  });

  // Keyboard
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.getElementById("sidebar")?.classList.remove("open");
      document.getElementById("user-popup")?.classList.add("hidden");
      document.getElementById("search-input")?.classList.remove("active");
    }
  });
});
</script>
</body>
</html>
