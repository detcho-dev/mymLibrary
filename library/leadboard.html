<!DOCTYPE html>
<html lang="en" class="scroll-smooth dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="icon.ico" type="image/x-icon" />
    <title>Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                light: "#3b82f6",
                dark: "#60a5fa",
              },
            },
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              "fade-in": "fadeIn 0.5s ease-in-out",
            },
            keyframes: {
              fadeIn: {
                "0%": { opacity: "0", transform: "translateY(10px)" },
                "100%": { opacity: "1", transform: "translateY(0)" },
              },
            },
          },
        },
      };
    </script>
    <style>
      .medal-glow {
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        animation: glow 2s infinite alternate;
      }
      @keyframes glow {
        from {
          box-shadow: 0 0 5px rgba(255, 215, 0, 0.7);
        }
        to {
          box-shadow: 0 0 20px rgba(255, 215, 0, 0.9);
        }
      }
      .leaderboard-item:nth-child(1) {
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
      }
      .leaderboard-item:last-child {
        border-bottom-left-radius: 1rem;
        border-bottom-right-radius: 1rem;
      }
      .highlighted-user {
        background-color: rgba(59, 130, 246, 0.15) !important;
        border-left: 4px solid #3b82f6;
      }
    </style>
  </head>
  <body class="bg-gray-900 min-h-screen flex flex-col items-center p-4 text-white">
    <!-- Language Toggle Button -->
    <button
      id="langToggle"
      class="absolute top-4 right-4 p-2.5 rounded-full bg-gray-800 text-gray-200 shadow-md hover:bg-gray-700 transition-all duration-300 z-50"
    >
      <span class="font-medium">EN</span> / <span class="font-medium">AR</span>
    </button>

    <div class="max-w-2xl w-full">
      <!-- Header -->
      <div class="text-center mb-10 animate-fade-in">
        <div class="flex justify-center items-center mb-4">
          <div
            class="bg-blue-600 p-4 rounded-2xl shadow-lg transform hover:scale-105 transition-transform duration-300"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-10 w-10 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 14v6m4-12v18M20 8v12a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2h12a2 2 0 012 2z"
              />
            </svg>
          </div>
        </div>
        <h1
          id="pageTitle"
          class="text-4xl md:text-5xl font-extrabold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent animate-pulse-slow"
        >
          ðŸ“š Leaderboard
        </h1>
        <p
          id="pageSubtitle"
          class="text-gray-400 mt-3 text-lg max-w-2xl mx-auto px-4"
        >
          Track your reading journey and compete with others
        </p>
      </div>

      <!-- Leaderboard -->
      <div
        class="bg-gray-800 shadow-xl rounded-2xl p-6 border border-gray-700 transition-all duration-300 overflow-hidden"
      >
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
          <h2
            id="leaderboardTitle"
            class="text-2xl font-bold flex items-center mb-3 md:mb-0"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-yellow-400 mr-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"
              />
            </svg>
            <span>Top Readers</span>
          </h2>
          <div class="flex space-x-2 justify-center md:justify-end">
            <div class="w-3 h-3 bg-yellow-400 rounded-full" title="1st Place"></div>
            <div class="w-3 h-3 bg-gray-400 rounded-full" title="2nd Place"></div>
            <div class="w-3 h-3 bg-orange-400 rounded-full" title="3rd Place"></div>
          </div>
        </div>

        <div
          class="overflow-hidden rounded-xl border border-gray-700 bg-gray-900/50"
        >
          <ul
            id="leaderboardList"
            class="divide-y divide-gray-700"
          ></ul>

          <div id="loadingIndicator" class="flex justify-center py-8">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
          </div>
        </div>

        <div class="mt-6 text-center">
          <p id="updateNotice" class="text-sm text-gray-500">
            Leaderboard updates in real-time as you read more books
          </p>
        </div>
      </div>
    </div>

    <footer class="mt-12 text-center text-gray-500 text-sm">
      <p id="footerText" class="flex items-center justify-center">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4 mr-1 text-blue-400"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
        <span>Reading makes a full man</span>
      </p>
    </footer>

    <script type="module">
      // Translations
      const translations = {
        en: {
          pageTitle: "ðŸ“š Leaderboard",
          pageSubtitle: "Track your reading journey and compete with others",
          leaderboardTitle: "Top Readers",
          updateNotice: "Leaderboard updates in real-time as you read more books",
          footerText: "Reading makes a full man",
          noPlayers: "No readers yet.",
          booksText: "Books",
          errorNoUserId: "User ID is required to view the leaderboard.",
        },
        ar: {
          pageTitle: "ðŸ“š Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†",
          pageSubtitle: "ØªØªØ¨Ø¹ Ø±Ø­Ù„ØªÙƒ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØªÙ†Ø§ÙØ³ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†",
          leaderboardTitle: "Ø£ÙØ¶Ù„ Ø§Ù„Ù‚Ø±Ù‘Ø§Ø¡",
          updateNotice: "ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ Ø¹Ù†Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ÙƒØªØ¨",
          footerText: "Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ØªØ¬Ø¹Ù„ Ø§Ù„Ø¥Ù†Ø³Ø§Ù† ÙƒØ§Ù…Ù„Ø§Ù‹",
          noPlayers: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‚Ø±Ù‘Ø§Ø¡ Ø¨Ø¹Ø¯.",
          booksText: "ÙƒØªØ¨",
          errorNoUserId: "Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†.",
        },
      };

      // Get userId from URL
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get("userId");

      if (!userId) {
        alert("User ID is required!");
        throw new Error("Missing userId parameter");
      }

      // Language setup
      let currentLang = localStorage.getItem("language") || "en";
      const dir = currentLang === "ar" ? "rtl" : "ltr";
      document.documentElement.setAttribute("lang", currentLang);
      document.documentElement.setAttribute("dir", dir);
      document.body.className = document.body.className.replace(/(ltr|rtl)/g, "").trim() + ` ${dir}`;

      // Translate
      function translatePage() {
        document.getElementById("pageTitle").textContent = translations[currentLang].pageTitle;
        document.getElementById("pageSubtitle").textContent = translations[currentLang].pageSubtitle;
        document.getElementById("leaderboardTitle").textContent = translations[currentLang].leaderboardTitle;
        document.getElementById("updateNotice").textContent = translations[currentLang].updateNotice;
        document.getElementById("footerText").lastChild.textContent = translations[currentLang].footerText;

        document.querySelectorAll(".books-text").forEach((el) => {
          el.textContent = translations[currentLang].booksText;
        });

        const newDir = currentLang === "ar" ? "rtl" : "ltr";
        document.documentElement.setAttribute("dir", newDir);
        document.body.className = document.body.className.replace(/(ltr|rtl)/g, "").trim() + ` ${newDir}`;

        localStorage.setItem("language", currentLang);
        document.getElementById("langToggle").innerHTML = `<span class="font-medium">${currentLang.toUpperCase()}</span> / <span class="font-medium">${
          currentLang === "en" ? "AR" : "EN"
        }</span>`;
      }

      document.getElementById("langToggle").addEventListener("click", () => {
        currentLang = currentLang === "en" ? "ar" : "en";
        translatePage();
      });

      translatePage();

      // Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        orderBy,
        limit,
        onSnapshot,
        doc,
        getDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBlOVx-YSmPFeq3lp-gAGe576yG1RhMLYs",
        authDomain: "mymlibraryreads.firebaseapp.com",
        projectId: "mymlibraryreads",
        storageBucket: "mymlibraryreads.firebasestorage.app",
        messagingSenderId: "11947740896",
        appId: "1:11947740896:web:87482eb72210acdba50a85",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const leaderboardList = document.getElementById("leaderboardList");
      const loadingIndicator = document.getElementById("loadingIndicator");

      // Scroll to user and update score from localStorage
      function updateScoreAndScroll() {
        try {
          let readCount = 0;
          const stored = localStorage.getItem("readBooks");
          if (stored) {
            const parsed = JSON.parse(stored);
            readCount = Array.isArray(parsed) ? parsed.length : parseInt(stored, 10) || 0;
          }

          // Update Firestore
          const userRef = doc(db, "users", userId);
          setDoc(userRef, { readCount }, { merge: true });

          // Scroll to user if already rendered
          setTimeout(() => {
            const userRow = document.querySelector(".highlighted-user");
            if (userRow) {
              userRow.scrollIntoView({ behavior: "smooth", block: "center" });
            }
          }, 500);
        } catch (err) {
          console.warn("Failed to update score from localStorage:", err);
        }
      }

      // Initial score sync
      updateScoreAndScroll();

      // Real-time: listen to localStorage changes (from other tabs)
      window.addEventListener("storage", (event) => {
        if (event.key === "readBooks") {
          updateScoreAndScroll();
        }
      });

      // Listen to leaderboard updates
      const q = query(collection(db, "users"), orderBy("readCount", "desc"), limit(10));
      onSnapshot(q, (snapshot) => {
        leaderboardList.innerHTML = "";
        loadingIndicator.style.display = "none";
        let rank = 0;
        let currentUserElement = null;

        snapshot.forEach((docSnap) => {
          rank++;
          const data = docSnap.data();
          const isCurrentUser = docSnap.id === userId;

          let bgColor = "bg-gray-900/50";
          let medalIcon = "";

          if (rank === 1) {
            bgColor = "bg-yellow-900/30 border-l-4 border-yellow-400";
            medalIcon = `<div class="medal-glow rounded-full bg-yellow-400 text-white w-8 h-8 flex items-center justify-center font-bold text-lg mr-3">1</div>`;
          } else if (rank === 2) {
            bgColor = "bg-gray-800/50 border-l-4 border-gray-400";
            medalIcon = `<div class="rounded-full bg-gray-400 text-white w-8 h-8 flex items-center justify-center font-bold text-lg mr-3">2</div>`;
          } else if (rank === 3) {
            bgColor = "bg-orange-900/30 border-l-4 border-orange-400";
            medalIcon = `<div class="rounded-full bg-orange-400 text-white w-8 h-8 flex items-center justify-center font-bold text-lg mr-3">3</div>`;
          } else {
            medalIcon = `<div class="rounded-full bg-blue-900/50 text-blue-300 w-8 h-8 flex items-center justify-center font-bold text-lg mr-3">${rank}</div>`;
          }

          if (isCurrentUser) {
            bgColor += " highlighted-user";
          }

          const li = document.createElement("li");
          li.className = `leaderboard-item flex flex-col md:flex-row md:items-center justify-between p-4 ${bgColor} text-white transition-all duration-200 hover:shadow-md rounded-lg`;

          const dirClass = currentLang === "ar" ? "text-right" : "text-left";
          const flexDir = currentLang === "ar" ? "flex-row-reverse" : "flex-row";

          li.innerHTML = `
            <div class="flex ${flexDir} items-center mb-3 md:mb-0 ${dirClass}">
              ${medalIcon}
              <span class="font-semibold text-lg">${data.name || "Anonymous"}</span>
              ${isCurrentUser ? `<span class="ml-2 text-blue-400 font-bold">(You)</span>` : ""}
            </div>
            <div class="text-center bg-gray-800 p-3 rounded-lg shadow min-w-[90px] border border-gray-700">
              <span class="font-bold text-xl text-blue-400">${data.readCount || 0}</span>
              <div class="text-xs text-gray-400 mt-1 books-text">${translations[currentLang].booksText}</div>
            </div>
          `;
          leaderboardList.appendChild(li);

          if (isCurrentUser) currentUserElement = li;
        });

        if (rank === 0) {
          const empty = document.createElement("li");
          empty.className = "p-6 text-center text-gray-500 font-medium";
          empty.textContent = translations[currentLang].noPlayers;
          leaderboardList.appendChild(empty);
        }

        // Auto-scroll after initial render
        if (currentUserElement) {
          currentUserElement.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      });

    </script>
  </body>
</html>
