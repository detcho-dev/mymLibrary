<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Browse and explore our collection of the best and most popular books available in MYM Library." />
  <link rel="icon" href="icon.ico" type="image/x-icon" />
  <title>MYM Library - Explore Books</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .btn-primary {
      background-color: #1d4ed8;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      font-weight: 600;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 100%;
    }
    .btn-primary:hover {
      background-color: #2563eb;
      transform: translateY(-3px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
    }
    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .btn-secondary {
      background-color: #4CAF50;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      font-weight: 600;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .btn-secondary:hover {
      background-color: #45a049;
      transform: translateY(-3px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
    }
    .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .most-read-badge {
      background: linear-gradient(135deg, white, #fcd34d, #fbbf24);
    }
    .i {
      font-size: 15px;
      font-weight: bold;
      background: linear-gradient(315deg, #020024 0%, #090979 35%, #00d4ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">

  <!-- Header -->
  <header class="fixed top-0 left-0 w-full bg-white shadow-md z-50">
    <nav class="container mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="logo.png" alt="MYM Library Logo" class="w-12 h-12 object-cover" />
        <h1 class="text-2xl font-heading">MYM Library</h1>
      </div>
      <div class="text-center mt-0">
        <p>Books You've Read: <span id="read-count">0</span></p>
      </div>
      <ul class="flex gap-6">
        <li><a href="https://mymlibrary.vercel.app" class="hover:text-blue-500 transition-colors">Home</a></li>
      </ul>
    </nav>
  </header>

  <!-- Content -->
  <div class="container mx-auto mt-24">
    <h1 class="text-3xl font-bold mb-6 flex justify-center">All Books</h1>

    <!-- Search -->
    <div class="flex justify-center w-full my-6">
      <input id="search-input" type="search" placeholder="Search for books..."
        class="w-1/2 md:w-1/3 lg:w-1/4 px-4 py-2 rounded-[34px] border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 ease-in-out focus:w-2/3 md:focus:w-1/2 lg:focus:w-1/3">
    </div>

    <!-- Books List -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">

      <!-- Section Title -->
      <div class="col-span-full">
        <h2 class="text-xl font-bold mb-2">Books written by <span class="text-blue-600">members</span> of the library</h2>
        <hr class="mb-4">
      </div>

      <!-- Book 1 -->
      <div class="relative bg-white p-4 rounded-sm shadow-sm book"
           data-book-id="du"
           data-title="Du - دو"
           data-author="Youssef Ahmed">
        <span class="most-read-badge absolute top-4 left-4 text-black text-sm font-semibold px-2 py-1 rounded shadow hidden">
          Most Read
        </span>
        <img src="https://res.cloudinary.com/dqyxzsnyq/image/upload/v1735652511/2text_f9ohsk.jpg"
          alt="Book 1" class="w-full h-64 object-cover rounded-sm mb-4" />
        <h3 class="font-heading text-xl mb-2">Du - دو</h3>
        <p class="text-accent mb-2">By Youssef Ahmed</p>
        <p class="text-accent mb-2">Adventure, Fantasy</p>
        <button class="btn-primary w-full mb-2" data-purchase="Du - دو [FREE EDITION]">Download Now</button>
        <button class="btn-secondary w-full read-btn" data-book-id="001">✅ I’ve Read This Book</button>
      </div>

      <!-- Book 2 -->
      <div class="relative bg-white p-4 rounded-sm shadow-sm book"
           data-book-id="eight"
           data-title="The Eight Worlds - العوالم الثمانية"
           data-author="Mohammed Osama">
        <span class="most-read-badge absolute top-4 left-4 text-black text-sm font-semibold px-2 py-1 rounded shadow hidden">
          Most Read
        </span>
        <img src="https://res.cloudinary.com/dqyxzsnyq/image/upload/v1738757292/8_title_e7esmh.jpg"
          alt="Book 2" class="w-full h-64 object-cover rounded-sm mb-4" />
        <h3 class="font-heading text-xl mb-2">العوالم الثمانية - The Eight Worlds</h3>
        <p class="text-accent mb-2">By Mohammed Osama</p>
        <p class="text-accent mb-2">Mystery, Fantasy</p>
        <button class="btn-primary w-full mb-2" data-purchase="العوالم الثمانية - The Eight Worlds (FREE EDITION)">Download Now</button>
        <button class="btn-secondary w-full read-btn" data-book-id="002">✅ I’ve Read This Book</button>
      </div>

      <!-- Section Title -->
      <div class="col-span-full mt-6">
        <h2 class="text-xl font-bold mb-2">Books written by <span class="text-purple-600">library Readers</span></h2>
        <hr class="mb-4">
      </div>

      <!-- Book 3 -->
      <div class="relative bg-white p-4 rounded-sm shadow-sm book"
           data-book-id="adam"
           data-title="Adam and the Secret of the Disappearance of the Al-Zaher Family - أدم وسر اختفاء عائلة الزاهر"
           data-author="Roshdy Reda">
        <span class="most-read-badge absolute top-4 left-4 text-black text-sm font-semibold px-2 py-1 rounded shadow hidden">
          Most Read
        </span>
        <img src="https://res.cloudinary.com/dqyxzsnyq/image/upload/v1744916535/cover1_ad2ttj.png"
          alt="Book 3" class="w-full h-64 object-cover rounded-sm mb-4" />
        <h3 class="font-heading text-xl mb-2">Adam and the Secret of the Disappearance of the Al-Zaher Family - أدم وسر اختفاء عائلة الزاهر</h3>
        <p class="text-accent mb-2">By Roshdy Reda <span class="i">New Guest!!</span></p>
        <p class="text-accent mb-2">Mystery, Police</p>
        <button class="btn-primary w-full mb-2" data-purchase="Adam and the Secret of the Disappearance of the Al-Zaher Family - أدم وسر اختفاء عائلة الزاهر">Download Now</button>
        <button class="btn-secondary w-full read-btn" data-book-id="003">✅ I’ve Read This Book</button>
      </div>

    </div>
  </div>

  <!-- JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, updateDoc, increment, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBlOVx-YSmPFeq3lp-gAGe576yG1RhMLYs",
    authDomain: "mymlibraryreads.firebaseapp.com",
    projectId: "mymlibraryreads",
    storageBucket: "mymlibraryreads.firebasestorage.app",
    messagingSenderId: "11947740896",
    appId: "1:11947740896:web:87482eb72210acdba50a85"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Local Storage helpers
  function getReadBooks() {
    try { return JSON.parse(localStorage.getItem("readBooks") || "[]"); }
    catch { return []; }
  }
  function setReadBooks(books) { localStorage.setItem("readBooks", JSON.stringify(books)); }
  function updateReadCounterUI() {
    document.getElementById("read-count").textContent = getReadBooks().length;
  }

  // Update Most Read badge
  async function updateMostReadTag() {
    try {
      const snapshot = await getDocs(collection(db, "Books"));
      let maxReads = 0;
      const readsMap = {};

      snapshot.forEach(docSnap => {
        const id = docSnap.id;
        const reads = Number(docSnap.data().Reads) || 0;
        readsMap[id] = reads;
        if (reads > maxReads) maxReads = reads;
      });

      // تحديث الواجهة
      document.querySelectorAll(".book").forEach(bookEl => {
        const badge = bookEl.querySelector(".most-read-badge");
        if (!badge) return;
        const id = bookEl.dataset.bookId;

        // إظهار التاج إذا كانت قراءات الكتاب هي الأعلى
        if (readsMap[id] === maxReads && maxReads > 0) {
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }
      });
    } catch (err) {
      console.error("Error updating most read tag:", err);
    }
  }

  // Mark as read
  async function markAsRead(bookId) {
    let readBooks = getReadBooks();
    if (!readBooks.includes(bookId)) {
      readBooks.push(bookId);
      setReadBooks(readBooks);
      updateReadCounterUI();
      try {
        await updateDoc(doc(db, "Books", bookId), { Reads: increment(1) });
        await updateMostReadTag();
      } catch (err) { console.error(err); }
    }
  }

  // Search books
  function searchBooks() {
    const input = document.getElementById("search-input").value.trim().toLowerCase();
    document.querySelectorAll(".book").forEach(book => {
      if (input === "") {
        book.style.display = "block"; // عرض كل الكتب لو السيرش فاضي
      } else {
        const title = book.dataset.title.toLowerCase();
        const author = book.dataset.author.toLowerCase();
        book.style.display = (title.includes(input) || author.includes(input)) ? "block" : "none";
      }
    });
  }

  // Purchase page redirect
  function goToPurchasePage1(bookName) {
    window.location.href = `/order1?book=${encodeURIComponent(bookName)}`;
  }

  // Init
  document.addEventListener("DOMContentLoaded", async () => {
    if (!localStorage.getItem("readBooks")) setReadBooks([]);
    updateReadCounterUI();
    await updateMostReadTag();

    document.querySelectorAll(".read-btn").forEach(btn =>
      btn.addEventListener("click", () => markAsRead(btn.dataset.bookId))
    );

    document.getElementById("search-input").addEventListener("keyup", searchBooks);

    document.querySelectorAll("[data-purchase]").forEach(btn =>
      btn.addEventListener("click", () => goToPurchasePage1(btn.dataset.purchase))
    );
  });
  </script>
</body>
</html>
