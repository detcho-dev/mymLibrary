<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Book Library</title>
  <link rel="stylesheet" href="books.css" />
</head>
<body>
  <!-- Header with counter -->
  <div class="read-counter">
    Books Read: <span id="read-count-gold">0</span>
  </div>

  <!-- Search -->
  <input type="text" id="search-input" placeholder="Search books..." />

  <!-- Loader -->
  <div id="loader">Loading books from Firebase...</div>

  <!-- Books Grid -->
  <div class="list"></div>

  <!-- Product Dialog -->
  <dialog id="productDialog">
    <div class="dialog-content">
      <img id="dialogImage" src="" alt="Book Cover" />
      <div class="dialog-text">
        <h1 id="dialogTitle">Book Title</h1>
        <p id="dialogDesc"></p>
      </div>
    </div>
    <div class="dia-btns">
      <button id="downloadDialogBtn">Download Now</button>
      <button id="queueDialogBtn">Add to Queue</button>
      <button id="closeDialogBtn">Close</button>
    </div>
  </dialog>

  <!-- Queue Menu -->
  <div id="queueMenu" class="queue-menu hidden">
    <h2>Download Queue</h2>
    <div id="queueList" class="queue-list"></div>
    <div class="queue-actions">
      <button id="downloadAllBtn">Download All</button>
      <button id="clearQueueBtn">Clear Queue</button>
    </div>
    <button id="closeQueueBtn" class="close-queue-btn">&times;</button>
  </div>

  <!-- Queue Toggle Button -->
  <button id="toggleQueueBtn" class="queue-toggle">Queue (0)</button>

  <!-- Scripts -->
  <script type="module" >
    // app.js
import { db } from './firebase-config.js';
import {
  collection,
  doc,
  updateDoc,
  increment,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ================== TOAST HELPER ==================
function showToast(message, isError = false) {
  // إزالة التوست القديم لو موجود
  const oldToast = document.querySelector('.toast');
  if (oldToast) oldToast.remove();

  const toast = document.createElement('div');
  toast.className = `toast ${isError ? 'error' : ''}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  // إظهار التوست
  setTimeout(() => toast.classList.add('show'), 10);

  // إخفاء التوست بعد 3 ثواني
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ================== DOM ELEMENTS ==================
const dialog = document.getElementById("productDialog");
const dialogTitle = document.getElementById("dialogTitle");
const dialogDesc = document.getElementById("dialogDesc");
const dialogImage = document.getElementById("dialogImage");
const downloadDialogBtn = document.getElementById("downloadDialogBtn");
const queueDialogBtn = document.getElementById("queueDialogBtn");
const closeDialogBtn = document.getElementById("closeDialogBtn");
const queueMenu = document.getElementById("queueMenu");
const queueList = document.getElementById("queueList");
const downloadAllBtn = document.getElementById("downloadAllBtn");
const clearQueueBtn = document.getElementById("clearQueueBtn");
const closeQueueBtn = document.getElementById("closeQueueBtn");
const toggleQueueBtn = document.getElementById("toggleQueueBtn");
const searchInput = document.getElementById("search-input");

// ================== QUEUE MANAGEMENT ==================
let downloadQueue = JSON.parse(localStorage.getItem("downloadQueue")) || [];

function updateQueueCount() {
  toggleQueueBtn.textContent = `Queue (${downloadQueue.length})`;
}

function renderQueue() {
  queueList.innerHTML = "";
  if (downloadQueue.length === 0) {
    queueList.innerHTML = "<p style='text-align:center; padding:20px; color:#7f8c8d;'>Queue is empty</p>";
    return;
  }

  downloadQueue.forEach((book, index) => {
    const item = document.createElement("div");
    item.className = "queue-item";
    item.innerHTML = `
      <img src="${book.cover}" alt="${book.title}">
      <div class="queue-item-info">
        <h4>${book.title}</h4>
      </div>
      <button class="remove-item" data-index="${index}">&times;</button>
    `;
    queueList.appendChild(item);
  });

  // ربط زر الحذف
  document.querySelectorAll(".remove-item").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const index = parseInt(e.target.dataset.index);
      downloadQueue.splice(index, 1);
      localStorage.setItem("downloadQueue", JSON.stringify(downloadQueue));
      renderQueue();
    });
  });

  updateQueueCount();
}

// ================== BOOK DOWNLOAD LOGIC ==================
function markButtonAsDownloaded(button) {
  button.innerHTML = '✅ Downloaded';
  button.disabled = true;
  button.classList.add('opacity-60', 'cursor-not-allowed');
}

async function downloadBook(book, buttonEl = null) {
  if (!book.downloadUrl) {
    showToast("Download link not available for this book.", true);
    return;
  }

  try {
    // محاولة تنزيل الملف
    const response = await fetch(book.downloadUrl, { method: 'HEAD' });
    
    if (!response.ok) throw new Error('File not found');

    // فتح رابط التحميل في تاب جديد (أو نفس التاب)
    window.open(book.downloadUrl, '_blank');

    // تعليم الزر كـ "تم التحميل"
    if (buttonEl) {
      markButtonAsDownloaded(buttonEl);
    }

    showToast(`"${book.title}" is downloading!`);

    // تحديث عداد الكتب المقروءة (اختياري)
    if (book.id) {
      try {
        await updateDoc(doc(db, "Books", book.id), { Reads: increment(1) });
      } catch (err) {
        console.warn("Failed to update read count:", err);
      }
    }

  } catch (error) {
    console.error("Download failed:", error);
    showToast(`Failed to download "${book.title}". File may not exist.`, true);
  }
}

function addToQueue(book) {
  const exists = downloadQueue.some(b => b.id === book.id);
  if (exists) {
    showToast("Already in queue!", true);
    return;
  }
  downloadQueue.push(book);
  localStorage.setItem("downloadQueue", JSON.stringify(downloadQueue));
  renderQueue();
  showToast("Added to queue!");
}

// ================== DIALOG ==================
function openDialog(book) {
  dialogTitle.textContent = book.title;
  dialogDesc.textContent = book.description;
  dialogImage.src = book.cover;
  dialog.showModal();

  downloadDialogBtn.onclick = () => {
    downloadBook(book);
    dialog.close();
  };
  queueDialogBtn.onclick = () => {
    addToQueue(book);
    dialog.close();
  };
}

// ================== RENDER BOOK ==================
function renderBookCard(book) {
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <img src="${book.cover}" alt="${book.title}">
    <h3>${book.title}</h3>
    <p class="description">${book.description}</p>
    <div class="card-buttons">
      <button class="download-btn" data-id="${book.id}">Download</button>
      <button class="add-queue-btn" data-id="${book.id}">Add to Queue</button>
    </div>
  `;

  const downloadBtn = card.querySelector(".download-btn");
  const queueBtn = card.querySelector(".add-queue-btn");

  downloadBtn.addEventListener("click", () => downloadBook(book, downloadBtn));
  queueBtn.addEventListener("click", () => addToQueue(book));
  
  card.addEventListener("click", (e) => {
    if (!e.target.closest("button")) openDialog(book);
  });

  document.querySelector(".list").appendChild(card);
}

// ================== SEARCH ==================
function handleSearch() {
  const term = searchInput.value.toLowerCase();
  document.querySelectorAll(".card").forEach(card => {
    const title = card.querySelector("h3").textContent.toLowerCase();
    const desc = card.querySelector(".description").textContent.toLowerCase();
    card.style.display = (title.includes(term) || desc.includes(term)) ? "block" : "none";
  });
}

// ================== DOWNLOAD FROM QUEUE ==================
async function downloadFromQueue(book, index) {
  await downloadBook(book);
  // بعد التحميل، امسح الكتاب من القائمة
  downloadQueue.splice(index, 1);
  localStorage.setItem("downloadQueue", JSON.stringify(downloadQueue));
  renderQueue();
  showToast(`"${book.title}" removed from queue after download.`);
}

// ================== INIT ==================
document.addEventListener("DOMContentLoaded", () => {
  renderQueue();
  
  // إغلاق الـ dialog
  closeDialogBtn.addEventListener("click", () => dialog.close());
  dialog.addEventListener("click", (e) => {
    const rect = dialog.getBoundingClientRect();
    const inDialog = e.clientX >= rect.left && e.clientX <= rect.right &&
                     e.clientY >= rect.top && e.clientY <= rect.bottom;
    if (!inDialog) dialog.close();
  });

  // قائمة الانتظار
  toggleQueueBtn.addEventListener("click", () => queueMenu.classList.toggle("hidden"));
  closeQueueBtn.addEventListener("click", () => queueMenu.classList.add("hidden"));
  
  downloadAllBtn.addEventListener("click", async () => {
    if (downloadQueue.length === 0) return showToast("Queue is empty!", true);
    
    for (let i = downloadQueue.length - 1; i >= 0; i--) {
      await downloadFromQueue(downloadQueue[i], i);
    }
    showToast("All books downloaded and removed from queue!");
  });
  
  clearQueueBtn.addEventListener("click", () => {
    if (downloadQueue.length === 0) return;
    if (confirm("Clear all books from queue?")) {
      downloadQueue = [];
      localStorage.setItem("downloadQueue", "[]");
      renderQueue();
      showToast("Queue cleared!");
    }
  });

  // بحث
  searchInput?.addEventListener("input", handleSearch);

  // تحميل الكتب من Firestore
  const booksRef = collection(db, "Books");
  onSnapshot(booksRef, (snapshot) => {
    document.getElementById("loader").style.display = "none";
    document.querySelector(".list").innerHTML = "";
    
    snapshot.forEach(doc => {
      const data = doc.data();
      renderBookCard({
        id: doc.id,
        title: data.Title,
        description: data.Description || data.description || "No description available.",
        cover: data.CoverURL || "https://via.placeholder.com/200x300?text=Book+Cover",
        downloadUrl: data.PurchaseText // ← تأكد أن هذا الحقل موجود في Firestore
      });
    });
  }, (error) => {
    console.error("Error loading books:", error);
    document.getElementById("loader").textContent = "Failed to load books.";
    showToast("Failed to load books from server.", true);
  });
});
  </script>
</body>
</html>
