<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Browse and explore our collection of the best and most popular books available in MYM Library." />
  <link rel="icon" href="icon.ico" type="image/x-icon" />
  <title>MYM Library - Explore Books</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
  .btn-primary {
    background-color: #1d4ed8;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 9999px;
    font-weight: 600;
    transition: all 0.3s ease-in-out;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    width: 100%;
  }
  .btn-primary:hover {
    background-color: #2563eb;
    transform: translateY(-3px);
    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
  }
  .btn-primary:active {
    transform: translateY(1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .most-read-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    font-weight: bold;
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    z-index: 5;
  }
  .i {
    font-size: 15px;
    font-weight: bold;
    background: linear-gradient(315deg, #020024 0%, #090979 35%, #00d4ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .hidden { display: none; }
  .gold-card {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    padding: 0.8rem 1.5rem;
    border-radius: 12px;
    font-weight: bold;
    font-size: 1.1rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: inline-block;
    min-width: 160px;
    max-width: 90%;
    word-wrap: break-word;
  }
  </style>
</head>
<body class="bg-gray-100 p-6">

<header class="fixed top-0 left-0 w-full bg-white shadow-md z-50">
  <nav class="container mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <img src="logo.png" alt="MYM Library Logo" class="w-12 h-12 object-cover" />
      <h1 class="text-2xl font-heading">MYM Library</h1>
    </div>
    <ul class="flex gap-6">
      <li><a href="https://mymlibrary.vercel.app" class="hover:text-blue-500 transition-colors">Home</a></li>
    </ul>
  </nav>
</header>

<div class="container mx-auto mt-24">
  <div class="flex justify-center my-4">
    <div id="gold-card" class="gold-card text-center">
      You've Read :  <span id="read-count-gold">0</span> Book(s)
    </div>
  </div>
  <h1 class="text-3xl font-bold mb-6 flex justify-center">All Books</h1>

  <div class="flex justify-center w-full my-6">
    <input id="search-input" type="search" placeholder="Search for books..."
      class="w-1/2 md:w-1/3 lg:w-1/4 px-4 py-2 rounded-[34px] border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 ease-in-out focus:w-2/3 md:focus:w-1/2 lg:focus:w-1/3">
  </div>

  <!-- Members Books -->
  <div id="books-members" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    <div class="col-span-full">
      <h2 class="text-xl font-bold mb-2">Books written by <span class="text-blue-600">members</span> of the library</h2>
      <hr class="mb-4">
    </div>
  </div>

  <!-- Readers Books -->
  <div id="books-readers" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-6">
    <div class="col-span-full">
      <h2 class="text-xl font-bold mb-2">Books written by <span class="text-purple-600">library Readers</span></h2>
      <hr class="mb-4">
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, updateDoc, increment, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlOVx-YSmPFeq3lp-gAGe576yG1RhMLYs",
  authDomain: "mymlibraryreads.firebaseapp.com",
  projectId: "mymlibraryreads",
  storageBucket: "mymlibraryreads.firebasestorage.app",
  messagingSenderId: "11947740896",
  appId: "1:11947740896:web:87482eb72210acdba50a85"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function getReadBooks() {
  try { return JSON.parse(localStorage.getItem("readBooks") || "[]"); }
  catch { return []; }
}
function setReadBooks(books) {
  localStorage.setItem("readBooks", JSON.stringify(books));
}

function updateReadCounterUI() {
  const newCount = getReadBooks().length;
  const countEl = document.getElementById("read-count-gold");
  if (!countEl) return;
  const oldCount = Number(countEl.textContent) || 0;
  countEl.textContent = newCount;
  if (newCount > oldCount) {
    confetti({ particleCount: 80, spread: 70, origin: { y: 0.6 } });
  }
}

async function updateMostReadTag() {
  const snapshot = await getDocs(collection(db, "Books"));
  let maxReads = -1;
  let readsMap = {};
  snapshot.forEach(docSnap => {
    const id = docSnap.id;
    const reads = Number(docSnap.data().Reads) || 0;
    readsMap[id] = reads;
    if (reads > maxReads) maxReads = reads;
  });
  document.querySelectorAll(".book").forEach(bookEl => {
    const badge = bookEl.querySelector(".most-read-badge");
    if (!badge) return;
    const id = bookEl.dataset.bookId;
    if (readsMap[id] === maxReads && maxReads > 0) {
      badge.style.display = "inline-block";
    } else {
      badge.style.display = "none";
    }
  });
}

async function markAsRead(bookId) {
  let readBooks = getReadBooks();
  if (!readBooks.includes(bookId)) {
    readBooks.push(bookId);
    setReadBooks(readBooks);
    updateReadCounterUI();
    try {
      await updateDoc(doc(db, "Books", bookId), { Reads: increment(1) });
      await updateMostReadTag();
    } catch (err) {
      console.error(err);
    }
  }
}

function searchBooks() {
  const input = document.getElementById("search-input").value.trim().toLowerCase();
  document.querySelectorAll(".book").forEach(book => {
    if (input === "") {
      book.style.display = "block";
    } else {
      const title = book.dataset.title.toLowerCase();
      const author = book.dataset.author.toLowerCase();
      book.style.display = (title.includes(input) || author.includes(input)) ? "block" : "none";
    }
  });
}

function goToPurchasePage1(bookName) {
  window.location.href = `/order1?book=${encodeURIComponent(bookName)}`;
}

async function handleDownload(bookId, bookName, buttonEl) {
  await markAsRead(bookId);
  buttonEl.textContent = "✅ Already Read";
  buttonEl.disabled = true;
  buttonEl.classList.add("opacity-60", "cursor-not-allowed");
  goToPurchasePage1(bookName);
}

function attachBookEvents() {
  document.querySelectorAll(".book").forEach(bookEl => {
    const downloadBtn = bookEl.querySelector("[data-purchase]");
    if (downloadBtn) {
      if (getReadBooks().includes(bookEl.dataset.bookId)) {
        downloadBtn.textContent = "✅ Already Read";
        downloadBtn.disabled = true;
        downloadBtn.classList.add("opacity-60", "cursor-not-allowed");
      }
      downloadBtn.addEventListener("click", () => {
        handleDownload(bookEl.dataset.bookId, downloadBtn.dataset.purchase, downloadBtn);
      });
    }
  });
}

async function loadBooks() {
  const membersContainer = document.getElementById("books-members");
  const readersContainer = document.getElementById("books-readers");

  const snapshot = await getDocs(collection(db, "Books"));
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const bookEl = document.createElement("div");
    bookEl.className = "relative bg-white p-4 rounded-sm shadow-sm book";
    bookEl.dataset.bookId = docSnap.id;
    bookEl.dataset.title = data.Title;
    bookEl.dataset.author = data.Author;

    bookEl.innerHTML = `
      <span class="most-read-badge hidden">Most Read</span>
      <img src="${data.CoverURL}" alt="${data.Title}" class="w-full h-64 object-cover rounded-sm mb-4" />
      <h3 class="font-heading text-xl mb-2">${data.Title}</h3>
      <p class="text-accent mb-2">By ${data.Author}</p>
      <p class="text-accent mb-2">${Array.isArray(data.Categories) ? data.Categories.join(", ") : ""}</p>
      <button class="btn-primary w-full mb-2" data-purchase="${data.PurchaseText}">Download Now</button>
    `;

    if (data.Section === "members") {
      membersContainer.appendChild(bookEl);
    } else {
      readersContainer.appendChild(bookEl);
    }
  });

  attachBookEvents();
  await updateMostReadTag();
}

document.addEventListener("DOMContentLoaded", async () => {
  if (!localStorage.getItem("readBooks")) setReadBooks([]);
  updateReadCounterUI();
  await loadBooks();

  document.getElementById("search-input").addEventListener("keyup", searchBooks);
});
</script>
</body>
</html>
