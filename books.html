<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MYM Library - Explore Books</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn-primary {
      background-color: #1d4ed8;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      font-weight: 600;
      transition: all 0.3s ease-in-out;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 100%;
    }
    .btn-primary:hover {
      background-color: #2563eb;
      transform: translateY(-3px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
    }
    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .most-read-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #000;
      font-weight: bold;
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      z-index: 5;
    }
    .gold-card {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #000;
      padding: 0.8rem 1.5rem;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1.1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      display: inline-block;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">

  <!-- Header -->
  <header class="fixed top-0 left-0 w-full bg-white shadow-md z-50">
    <nav class="container mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="logo.png" alt="MYM Library Logo" class="w-12 h-12" />
        <h1 class="text-2xl font-heading">MYM Library</h1>
      </div>
      <ul class="flex gap-6">
        <li><a href="https://mymlibrary.vercel.app" class="hover:text-blue-500">Home</a></li>
      </ul>
    </nav>
  </header>

  <!-- Content -->
  <div class="container mx-auto mt-24">
    <div class="flex justify-center my-4">
      <div id="gold-card" class="gold-card text-center">
        You've Read : <span id="read-count-gold">0</span> Book(s)
      </div>
    </div>
    <h1 class="text-3xl font-bold mb-6 flex justify-center">All Books</h1>

    <!-- Search -->
    <div class="flex justify-center w-full my-6">
      <input id="search-input" type="search" placeholder="Search for books..."
        class="w-1/2 md:w-1/3 px-4 py-2 rounded-[34px] border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <!-- Books List -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">

      <!-- Example Book -->
      <div class="relative bg-white p-4 rounded-sm shadow-sm book"
           data-book-id="001"
           data-title="Du - دو"
           data-author="Youssef Ahmed"
           data-file="book1.pdf">
        <span class="most-read-badge hidden">Most Read</span>
        <img src="https://res.cloudinary.com/dqyxzsnyq/image/upload/v1735652511/2text_f9ohsk.jpg"
          alt="Book 1" class="w-full h-64 object-cover rounded-sm mb-4" />
        <h3 class="font-heading text-xl mb-2">Du - دو</h3>
        <p>By Youssef Ahmed</p>
        <p>Adventure, Fantasy</p>
        <button class="btn-primary download-btn" data-purchase="Du - دو [FREE EDITION]">Download Now</button>
      </div>

      <!-- Book 2 -->
      <div class="relative bg-white p-4 rounded-sm shadow-sm book"
           data-book-id="002"
           data-title="The Eight Worlds - العوالم الثمانية"
           data-author="Mohammed Osama"
           data-file="book2.pdf">
        <span class="most-read-badge hidden">Most Read</span>
        <img src="https://res.cloudinary.com/dqyxzsnyq/image/upload/v1738757292/8_title_e7esmh.jpg"
          alt="Book 2" class="w-full h-64 object-cover rounded-sm mb-4" />
        <h3 class="font-heading text-xl mb-2">العوالم الثمانية - The Eight Worlds</h3>
        <p>By Mohammed Osama</p>
        <p>Mystery, Fantasy</p>
        <button class="btn-primary download-btn" data-purchase="العوالم الثمانية - The Eight Worlds (FREE EDITION)">Download Now</button>
      </div>

      <!-- Book 3 -->
      <div class="relative bg-white p-4 rounded-sm shadow-sm book"
           data-book-id="003"
           data-title="Adam and the Secret..."
           data-author="Roshdy Reda"
           data-file="book3.pdf">
        <span class="most-read-badge hidden">Most Read</span>
        <img src="https://res.cloudinary.com/dqyxzsnyq/image/upload/v1744916535/cover1_ad2ttj.png"
          alt="Book 3" class="w-full h-64 object-cover rounded-sm mb-4" />
        <h3 class="font-heading text-xl mb-2">Adam and the Secret...</h3>
        <p>By Roshdy Reda</p>
        <p>Mystery, Police</p>
        <button class="btn-primary download-btn" data-purchase="Adam and the Secret of the Disappearance of the Al-Zaher Family">Download Now</button>
      </div>

    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, updateDoc, increment, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlOVx-YSmPFeq3lp-gAGe576yG1RhMLYs",
  authDomain: "mymlibraryreads.firebaseapp.com",
  projectId: "mymlibraryreads",
  storageBucket: "mymlibraryreads.firebasestorage.app",
  messagingSenderId: "11947740896",
  appId: "1:11947740896:web:87482eb72210acdba50a85"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function getReadBooks() {
  return JSON.parse(localStorage.getItem("readBooks") || "[]");
}
function setReadBooks(books) {
  localStorage.setItem("readBooks", JSON.stringify(books));
}
function updateReadCounterUI() {
  const countEl = document.getElementById("read-count-gold");
  countEl.textContent = getReadBooks().length;
}

async function updateMostReadTag() {
  const snapshot = await getDocs(collection(db, "Books"));
  let maxReads = -1;
  let readsMap = {};
  snapshot.forEach(docSnap => {
    const id = docSnap.id;
    const reads = Number(docSnap.data().Reads) || 0;
    readsMap[id] = reads;
    if (reads > maxReads) maxReads = reads;
  });
  document.querySelectorAll(".book").forEach(bookEl => {
    const badge = bookEl.querySelector(".most-read-badge");
    const id = bookEl.dataset.bookId;
    badge.style.display = (readsMap[id] === maxReads && maxReads > 0) ? "inline-block" : "none";
  });
}

async function markAsRead(bookId) {
  let readBooks = getReadBooks();
  if (!readBooks.includes(bookId)) {
    readBooks.push(bookId);
    setReadBooks(readBooks);
    updateReadCounterUI();
    try {
      await updateDoc(doc(db, "Books", bookId), { Reads: increment(1) });
      await updateMostReadTag();
    } catch (err) {
      console.error(err);
    }
  }
}

function downloadBook(fileUrl) {
  const link = document.createElement("a");
  link.href = fileUrl;
  link.download = "";
  link.click();
}

document.addEventListener("DOMContentLoaded", async () => {
  if (!localStorage.getItem("readBooks")) setReadBooks([]);
  updateReadCounterUI();
  await updateMostReadTag();

  document.querySelectorAll(".download-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      const bookEl = e.target.closest(".book");
      const bookId = bookEl.dataset.bookId;
      const fileUrl = bookEl.dataset.file;

      const userData = localStorage.getItem("userData");
      if (!userData) {
        window.location.href = `/order1.html?bookId=${bookId}`;
        return;
      }
      markAsRead(bookId);
      downloadBook(fileUrl);
    });
  });

  document.getElementById("search-input").addEventListener("keyup", () => {
    const input = document.getElementById("search-input").value.trim().toLowerCase();
    document.querySelectorAll(".book").forEach(book => {
      const title = book.dataset.title.toLowerCase();
      const author = book.dataset.author.toLowerCase();
      book.style.display = (title.includes(input) || author.includes(input)) ? "block" : "none";
    });
  });
});
</script>
</body>
</html>
