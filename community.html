<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #121212;
      color: #e0e0e0;
      line-height: 1.6;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #333;
    }
    h1 {
      color: #d4af37;
      font-size: 2.2rem;
    }
    .auth-buttons {
      text-align: center;
      margin: 20px 0;
    }
    button {
      background-color: #5d4037;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin: 5px;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #4e342e;
    }
    #postForm {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      margin-bottom: 30px;
      display: none;
    }
    #postForm textarea {
      width: 100%;
      height: 100px;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 6px;
      resize: vertical;
      font-size: 1rem;
      background: #2a2a2a;
      color: #f0f0f0;
    }
    .post {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      margin-bottom: 25px;
    }
    .post-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .post-author {
      font-weight: bold;
      color: #d4af37;
      font-size: 1.1rem;
    }
    .post-time {
      color: #aaa;
      font-size: 0.9rem;
    }
    .post-content {
      margin: 12px 0;
      line-height: 1.7;
      color: #f0f0f0;
    }
    .mention {
      background-color: #1b5e20;
      padding: 2px 6px;
      border-radius: 4px;
      color: #a5d6a7;
      font-weight: bold;
    }
    .comment-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px dashed #444;
    }
    .comment-input {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .comment-input input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 0.95rem;
      background: #2a2a2a;
      color: #f0f0f0;
    }
    .comments-list {
      margin-top: 12px;
    }
    .comment-item {
      background: #2a2a2a;
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 6px;
      font-size: 0.95rem;
      color: #e0e0e0;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4caf50;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Tags */
    .user-tag {
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 8px;
      font-weight: bold;
      display: inline-block;
      vertical-align: middle;
    }
    .tag-premium {
      background: linear-gradient(to right, gold, #daa520);
      color: #333;
    }
    .tag-ultimate {
      background: linear-gradient(to right, #e0e0e0, white);
      color: #111;
      border: 1px solid #ccc;
    }
    .tag-mym {
      background-color: #4a90e2;
      color: white;
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ */
    .post-actions {
      margin: 12px 0;
    }
    .like-btn {
      background: none;
      border: none;
      color: #aaa;
      cursor: pointer;
      font-size: 1.1rem;
      transition: color 0.2s;
    }
    .like-btn:hover {
      color: red;
    }
    .like-btn.liked {
      color: red;
    }
    .show-more-comments {
      background: #5d4037;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      margin-top: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .show-more-comments:hover {
      background: #4e342e;
    }

    /* Modal */
    .modal {
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #2a2a2a;
      color: #f0f0f0;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      direction: rtl;
      text-align: right;
    }
    .modal-content input {
      background: #1e1e1e;
      color: #f0f0f0;
      border: 1px solid #444;
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .modal-content button {
      margin: 5px;
    }
  </style>
</head>
<body>

  <header>
    <h1>ğŸ“š Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡</h1>
    <p>Ø´Ø§Ø±Ùƒ Ø£ÙÙƒØ§Ø±ÙƒØŒ Ø§Ù‚Ø±Ø£ Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†ØŒ ÙˆØ§Ù†Ø¶Ù… Ù„Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ø£Ø¯Ø¨ÙŠ!</p>
  </header>

  <!-- Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© -->
  <button id="toggleLangBtn" style="position:fixed; top:10px; left:10px; background:#5d4037; color:white; border:none; padding:6px 12px; border-radius:4px; font-size:0.9rem; z-index:999;">EN</button>

  <div class="auth-buttons">
    <button id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google</button>
    <button id="logoutBtn" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†Ø´Ø± -->
  <div id="postForm">
    <h3>Ø§ÙƒØªØ¨ Ù…Ù†Ø´ÙˆØ±Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§</h3>
    <textarea id="postContent" placeholder="Ø´Ø§Ø±Ùƒ ÙÙƒØ±ØªÙƒ... ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… @Ø§Ø³Ù… Ù„Ø°ÙƒØ± Ù…Ø³ØªØ®Ø¯Ù…"></textarea>
    <br><br>
    <button id="submitPost">Ù†Ø´Ø±</button>
  </div>

  <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
  <div id="postsContainer">
    <p>ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª.</p>
  </div>

  <!-- ØªÙ†Ø¨ÙŠÙ‡ Ø¯Ø§Ø®Ù„ÙŠ -->
  <div id="toast" class="toast"></div>

  <!-- Modal Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù… -->
  <div id="nameModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Ø§Ø®ØªØ± Ø§Ø³Ù… Ø¹Ø±Ø¶Ùƒ</h3>
      <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù…ÙˆØ² Ø®Ø§ØµØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</p>
      <ul style="text-align:right; margin:10px 0; font-size:0.9rem; color:#bbb;">
        <li><code>$Ø§Ø³Ù…</code> â†’ Ø¹Ø¶Ùˆ MYM</li>
        <li><code>+Ø§Ø³Ù…</code> â†’ Ù‚Ø§Ø±Ø¦ Ù…Ù…ÙŠØ²</li>
        <li><code>++Ø§Ø³Ù…</code> â†’ Ù‚Ø§Ø±Ø¦ Ù†Ù‡Ø§Ø¦ÙŠ</li>
      </ul>
      <input type="text" id="customNameInput" placeholder="Ù…Ø«Ø§Ù„: +Ø£Ø­Ù…Ø¯" maxlength="30">
      <div>
        <button id="saveNameBtn">Ø­ÙØ¸</button>
        <button id="skipNameBtn">ØªØ®Ø·ÙŠ</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBAYrfz5i_aKOEHexo5ihPpeo4U6emUUUU",
      authDomain: "community-89f5e.firebaseapp.com",
      projectId: "community-89f5e",
      storageBucket: "community-89f5e.firebasestorage.app",
      messagingSenderId: "1007651115554",
      appId: "1:1007651115554:web:1e4ea88d88d780fdfab07b",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Ù…ØªØºÙŠØ± Ø§Ù„Ù„ØºØ©
    let currentLang = 'ar';

    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø©
    const tagTranslations = {
      'Ù‚Ø§Ø±Ø¦ Ù…Ù…ÙŠØ²': { en: 'Premium Reader', ar: 'Ù‚Ø§Ø±Ø¦ Ù…Ù…ÙŠØ²' },
      'Ù‚Ø§Ø±Ø¦ Ù†Ù‡Ø§Ø¦ÙŠ': { en: 'Ultimate Reader', ar: 'Ù‚Ø§Ø±Ø¦ Ù†Ù‡Ø§Ø¦ÙŠ' },
      'Ø¹Ø¶Ùˆ MYM': { en: 'MYM Member', ar: 'Ø¹Ø¶Ùˆ MYM' }
    };

    function getTranslatedTag(tagAr) {
      if (!tagAr) return '';
      return tagTranslations[tagAr]?.[currentLang] || tagAr;
    }

    function updateAllTags() {
      document.querySelectorAll('.user-tag').forEach(el => {
        const originalTag = el.dataset.original;
        if (originalTag) {
          el.textContent = getTranslatedTag(originalTag);
        }
      });
      document.getElementById('toggleLangBtn').textContent = currentLang === 'ar' ? 'EN' : 'Ø¹Ø±Ø¨ÙŠ';
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.innerText = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    function timeAgo(timestamp) {
      if (!timestamp?.toDate) return "Ø§Ù„Ø¢Ù†";
      const now = new Date();
      const postTime = timestamp.toDate();
      const diffMs = now - postTime;
      const diffMin = Math.floor(diffMs / 60000);
      const diffHr = Math.floor(diffMin / 60);
      const diffDay = Math.floor(diffHr / 24);

      if (diffDay > 0) return `Ù‚Ø¨Ù„ ${diffDay} ÙŠÙˆÙ…${diffDay === 1 ? '' : 'ÙŠÙ†'}`;
      if (diffHr > 0) return `Ù‚Ø¨Ù„ ${diffHr} Ø³Ø§Ø¹Ø©${diffHr === 1 ? '' : 'ÙŠÙ†'}`;
      if (diffMin > 0) return `Ù‚Ø¨Ù„ ${diffMin} Ø¯Ù‚ÙŠÙ‚Ø©${diffMin === 1 ? '' : 'ÙŠÙ†'}`;
      return "Ø§Ù„Ø¢Ù†";
    }

    function parseDisplayName(displayName) {
      let cleanName = displayName;
      let tag = null;
      let tagClass = "";

      if (displayName.startsWith("++")) {
        cleanName = displayName.substring(2).trim();
        tag = "Ù‚Ø§Ø±Ø¦ Ù†Ù‡Ø§Ø¦ÙŠ";
        tagClass = "tag-ultimate";
      } else if (displayName.startsWith("+")) {
        cleanName = displayName.substring(1).trim();
        tag = "Ù‚Ø§Ø±Ø¦ Ù…Ù…ÙŠØ²";
        tagClass = "tag-premium";
      } else if (displayName.startsWith("$")) {
        cleanName = displayName.substring(1).trim();
        tag = "Ø¹Ø¶Ùˆ MYM";
        tagClass = "tag-mym";
      }

      return { cleanName, tag, tagClass };
    }

    async function getUserName(uid) {
      const cached = localStorage.getItem(`userName_${uid}`);
      if (cached) return cached;

      const doc = await db.collection("users").doc(uid).get();
      let name = doc.exists ? doc.data().displayName || "Ù‚Ø§Ø±Ø¦" : "Ù‚Ø§Ø±Ø¦";
      localStorage.setItem(`userName_${uid}`, name);
      return name;
    }

    async function findUserByDisplayName(name) {
      const snapshot = await db.collection("users")
        .where("displayName", "==", name)
        .limit(1)
        .get();
      return snapshot.empty ? null : { uid: snapshot.docs[0].id };
    }

    async function parseMentions(text) {
      const mentionRegex = /@([^\s@]+)/g;
      let result = text;
      let match;
      while ((match = mentionRegex.exec(text)) !== null) {
        const username = match[1];
        const user = await findUserByDisplayName(username);
        if (user) {
          result = result.replace(
            `@${username}`,
            `<span class="mention">@${username}</span>`
          );
        }
      }
      return result;
    }

    async function promptCustomName(user) {
      const savedName = localStorage.getItem(`userName_${user.uid}`);
      if (savedName) return;

      let defaultName = user.displayName || "Ù‚Ø§Ø±Ø¦";
      if (["+", "$"].includes(defaultName[0]) || defaultName.startsWith("++")) {
        defaultName = defaultName.replace(/^(\+{1,2}|\$)/, "").trim();
      }

      const modal = document.getElementById("nameModal");
      const input = document.getElementById("customNameInput");
      const saveBtn = document.getElementById("saveNameBtn");
      const skipBtn = document.getElementById("skipNameBtn");

      input.value = defaultName;
      modal.style.display = "flex";

      saveBtn.onclick = null;
      skipBtn.onclick = null;

      return new Promise((resolve) => {
        saveBtn.onclick = async () => {
          const name = input.value.trim();
          if (name) {
            localStorage.setItem(`userName_${user.uid}`, name);
            await db.collection("users").doc(user.uid).set({ displayName: name }, { merge: true });
          }
          modal.style.display = "none";
          resolve();
        };

        skipBtn.onclick = async () => {
          localStorage.setItem(`userName_${user.uid}`, defaultName);
          await db.collection("users").doc(user.uid).set({ displayName: defaultName }, { merge: true });
          modal.style.display = "none";
          resolve();
        };
      });
    }

    async function loadPosts() {
      const container = document.getElementById("postsContainer");
      container.innerHTML = "<p>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>";

      try {
        const postsSnap = await db.collection("posts")
          .orderBy("createdAt", "desc")
          .limit(30)
          .get();

        let html = "";
        for (const postDoc of postsSnap.docs) {
          const data = postDoc.data();
          const authorNameRaw = await getUserName(data.authorId);
          const { cleanName, tag, tagClass } = parseDisplayName(authorNameRaw);
          const timeText = timeAgo(data.createdAt);
          const postId = postDoc.id;

          const likesSnap = await postDoc.ref.collection("likes").get();
          const likeCount = likesSnap.size;
          const likedByMe = likesSnap.docs.some(doc => doc.id === auth.currentUser?.uid);

          const commentsQuery = postDoc.ref.collection("comments").orderBy("createdAt");
          const [commentsSnap, totalCommentsSnap] = await Promise.all([
            commentsQuery.limit(2).get(),
            commentsQuery.get()
          ]);
          const totalComments = totalCommentsSnap.size;

          let commentsHtml = "";
          commentsSnap.forEach(c => {
            const cd = c.data();
            commentsHtml += `<div class="comment-item">â€¢ <b>${cd.commenterName || "Ù…Ø¬Ù‡ÙˆÙ„"}:</b> ${cd.text}</div>`;
          });

          const parsedContent = await parseMentions(data.content);

          html += `
            <div class="post" data-post-id="${postId}">
              <div class="post-header">
                <div>
                  <span class="post-author">${cleanName}</span>
                  ${tag ? `<span class="user-tag ${tagClass}" data-original="${tag}">${getTranslatedTag(tag)}</span>` : ''}
                </div>
                <span class="post-time">${timeText}</span>
              </div>
              <div class="post-content">${parsedContent.replace(/\n/g, '<br>')}</div>

              <div class="post-actions">
                <button class="like-btn ${likedByMe ? 'liked' : ''}" data-post-id="${postId}">
                  â¤ï¸ <span>${likeCount}</span>
                </button>
              </div>

              <div class="comment-section">
                <div><b>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (${totalComments})</b></div>
                <div class="comments-list">${commentsHtml || '<div style="color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯.</div>'}</div>
                
                ${totalComments > 2 ? `<button class="show-more-comments" data-post-id="${postId}">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>` : ''}

                <div class="comment-input">
                  <input type="text" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ù‹Ø§..." maxlength="200" class="comment-field">
                  <button class="add-comment-btn">Ø£Ø¶Ù</button>
                </div>
              </div>
            </div>
          `;
        }

        container.innerHTML = html || "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ†Ø´Ø±!</p>";

        // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
        document.querySelectorAll(".like-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
            if (!auth.currentUser) return showToast("Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ù‹Ø§!");
            const postId = btn.dataset.postId;
            const postRef = db.collection("posts").doc(postId);
            const likeRef = postRef.collection("likes").doc(auth.currentUser.uid);

            const isLiked = btn.classList.contains("liked");
            if (isLiked) {
              await likeRef.delete();
              btn.classList.remove("liked");
              btn.querySelector("span").textContent = parseInt(btn.querySelector("span").textContent) - 1;
            } else {
              await likeRef.set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() });
              btn.classList.add("liked");
              btn.querySelector("span").textContent = parseInt(btn.querySelector("span").textContent) + 1;
            }
          });
        });

        // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯"
        document.querySelectorAll(".show-more-comments").forEach(btn => {
          btn.addEventListener("click", async () => {
            const postId = btn.dataset.postId;
            const postEl = document.querySelector(`.post[data-post-id="${postId}"]`);
            const commentsList = postEl.querySelector(".comments-list");
            const allCommentsSnap = await db.collection("posts").doc(postId).collection("comments")
              .orderBy("createdAt")
              .get();

            let allCommentsHtml = "";
            allCommentsSnap.forEach(c => {
              const cd = c.data();
              allCommentsHtml += `<div class="comment-item">â€¢ <b>${cd.commenterName || "Ù…Ø¬Ù‡ÙˆÙ„"}:</b> ${cd.text}</div>`;
            });
            commentsList.innerHTML = allCommentsHtml;
            btn.style.display = "none";
          });
        });

        // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
        document.querySelectorAll(".add-comment-btn").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const postEl = e.target.closest(".post");
            const postId = postEl.dataset.postId;
            const input = postEl.querySelector(".comment-field");
            const text = input.value.trim();

            if (!text) return showToast("Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºÙ‹Ø§!");
            if (!auth.currentUser) return showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!");

            const userName = await getUserName(auth.currentUser.uid);

            try {
              await db.collection("posts").doc(postId).collection("comments").add({
                text,
                authorId: auth.currentUser.uid,
                commenterName: userName,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              input.value = "";
              showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚!");
              loadPosts();
            } catch (err) {
              console.error(err);
              showToast("Ø­Ø¯Ø« Ø®Ø·Ø£!");
            }
          });
        });

      } catch (err) {
        console.error("Error loading posts:", err);
        container.innerHTML = "<p>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.</p>";
      }
    }

    document.getElementById("submitPost").onclick = async () => {
      const content = document.getElementById("postContent").value.trim();
      if (!content) return showToast("Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºÙ‹Ø§!");
      if (!auth.currentUser) return showToast("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§!");

      const parsedContent = await parseMentions(content);
      const userName = await getUserName(auth.currentUser.uid);

      try {
        await db.collection("posts").add({
          content,
          authorId: auth.currentUser.uid,
          authorName: userName,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById("postContent").value = "";
        showToast("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±!");
        loadPosts();
      } catch (err) {
        console.error(err);
        showToast("ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±!");
      }
    };

    document.getElementById("loginBtn").onclick = async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;

        await db.collection("users").doc(user.uid).set({
          displayName: user.displayName,
          photoURL: user.photoURL,
          email: user.email
        }, { merge: true });

        await promptCustomName(user);
        updateUI();
      } catch (err) {
        console.error(err);
        showToast("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      }
    };

    document.getElementById("logoutBtn").onclick = () => {
      auth.signOut().then(updateUI);
    };

    function updateUI() {
      auth.onAuthStateChanged(async user => {
        const form = document.getElementById("postForm");
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");

        if (user) {
          loginBtn.style.display = "none";
          logoutBtn.style.display = "inline-block";
          form.style.display = "block";

          let avatar = document.getElementById("userAvatar");
          if (!avatar) {
            avatar = document.createElement("img");
            avatar.id = "userAvatar";
            avatar.style.cssText = "width:50px; height:50px; border-radius:50%; object-fit:cover; display:block; margin:0 auto 15px;";
            document.querySelector(".auth-buttons").insertAdjacentElement("beforebegin", avatar);
          }
          avatar.src = user.photoURL || "https://via.placeholder.com/50?text=ğŸ‘¤";

          loadPosts();
        } else {
          loginBtn.style.display = "inline-block";
          logoutBtn.style.display = "none";
          form.style.display = "none";
          const avatar = document.getElementById("userAvatar");
          if (avatar) avatar.remove();
          document.getElementById("postsContainer").innerHTML = "<p>ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª.</p>";
        }
      });
    }

    // Ø±Ø¨Ø· Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
    document.getElementById('toggleLangBtn').onclick = () => {
      currentLang = currentLang === 'ar' ? 'en' : 'ar';
      updateAllTags();
    };

    updateUI();
  </script>
</body>
</html>
